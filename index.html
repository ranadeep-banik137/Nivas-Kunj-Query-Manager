<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nivas Kunj | Entry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@800&family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-title { font-family: 'Plus Jakarta Sans', sans-serif; }
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-10 rounded-[40px] shadow-2xl max-w-md w-full border border-slate-100 transition-all">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-black text-zinc-900 tracking-tighter uppercase font-title">Nivas Kunj</h1>
            <p id="auth-subtitle" class="text-zinc-500 text-xs font-bold mt-2 uppercase tracking-widest">Client & Admin Workspace</p>
        </div>

        <div class="space-y-5">
            <div>
                <label class="text-[10px] font-bold text-zinc-400 uppercase ml-2 mb-1.5 block tracking-widest">Email Address</label>
                <input type="email" id="email" placeholder="name@email.com" 
                    class="w-full p-4 bg-zinc-50 border border-zinc-100 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition font-medium text-sm">
            </div>

            <div id="password-group">
                <div class="flex justify-between items-center ml-2 mb-1.5">
                    <label id="password-label" class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest">Password</label>
                    <button id="forgot-link" onclick="handleReset()" class="text-[9px] font-bold text-indigo-500 hover:text-indigo-700 uppercase tracking-widest">Forgot?</button>
                </div>
                <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" 
                    class="w-full p-4 bg-zinc-50 border border-zinc-100 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition font-medium text-sm">
            </div>

            <div class="grid grid-cols-1 gap-3 pt-4">
                <button id="mainBtn" class="w-full bg-zinc-900 text-white p-4 rounded-2xl font-bold text-[11px] uppercase tracking-[0.2em] hover:bg-indigo-600 transition shadow-xl shadow-zinc-100">
                    Sign In with Password
                </button>
                
                <div id="alt-methods" class="space-y-3">
                    <div class="relative py-4">
                        <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-zinc-100"></span></div>
                        <div class="relative flex justify-center text-[9px] uppercase font-black"><span class="bg-white px-4 text-zinc-300 tracking-[0.3em]">Alternative Access</span></div>
                    </div>

                    <button id="magicBtn" class="w-full bg-white border border-zinc-200 text-zinc-500 p-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-zinc-50 transition hover:text-zinc-800">
                        Send Magic Link
                    </button>

                    <button id="googleBtn" class="w-full bg-white border border-zinc-200 text-zinc-500 p-4 rounded-2xl font-bold text-[10px] uppercase tracking-widest hover:bg-zinc-50 transition flex items-center justify-center gap-3 hover:text-zinc-800">
                        <img src="https://www.google.com/favicon.ico" class="w-4 h-4 grayscale opacity-70"> Continue with Google
                    </button>
                </div>
            </div>
        </div>

        <p id="status" class="mt-8 text-center text-[10px] font-bold uppercase tracking-widest h-4 text-indigo-600"></p>
        
        <div class="mt-8 pt-6 border-t border-zinc-50 text-center">
            <p id="toggle-text" class="text-[10px] text-zinc-400 font-bold uppercase tracking-widest">
                New client? <button onclick="toggleMode('register')" class="text-indigo-600 ml-1 hover:underline">Register here</button>
            </p>
            <p class="text-[9px] font-black text-zinc-400 uppercase tracking-[0.3em] mt-6 flex items-center justify-center gap-2">
                Powered by <span class="text-emerald-500">Supabase</span>
            </p>
        </div>
    </div>

    <script>
        const S_URL = 'https://wbhcvcsdpdandaxidnlg.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiaGN2Y3NkcGRhbmRheGlkbmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjMwMjksImV4cCI6MjA4MTUzOTAyOX0.n8R1OpFxilWbDfteODc-lyVF_qvntyRnJNVM3g9xCWs'; 
        const sb = supabase.createClient(S_URL, S_KEY);

        let mode = 'login';
        const status = document.getElementById('status');

        window.onload = async () => {
			const params = new URLSearchParams(window.location.search);
			const hash = window.location.hash;

			// Detect if this is a Password Reset link
			if (hash.includes("type=recovery") || hash.includes("access_token")) {
				toggleMode('reset');
				status.innerText = "ðŸ”‘ Security Token Verified. Set your new password.";
			} 
			// Existing invite detection
			else if (params.get('email')) {
				document.getElementById('email').value = params.get('email');
				toggleMode('register');
			}
		};

        function toggleMode(targetMode) {
			mode = targetMode;
			const subtitle = document.getElementById('auth-subtitle');
			const mainBtn = document.getElementById('mainBtn');
			const altMethods = document.getElementById('alt-methods');
			const toggleText = document.getElementById('toggle-text');
			const passLabel = document.getElementById('password-label');
			const forgotLink = document.getElementById('forgot-link');
			
			// FIX: Define the email container so it can be hidden/shown
			const emailInput = document.getElementById('email');
			const emailGroup = emailInput.parentElement;

			if (mode === 'reset') {
				subtitle.innerText = "Set your new password";
				mainBtn.innerText = "Update Password";
				passLabel.innerText = "New Permanent Password";
				emailGroup.classList.add('hidden'); // Now emailGroup is defined
				forgotLink.classList.add('hidden');
				altMethods.classList.add('hidden');
				toggleText.innerHTML = `<button onclick="toggleMode('login')" class="text-zinc-400 font-bold uppercase text-[9px] tracking-widest">Cancel and go back</button>`;
			} else if (mode === 'register') {
				subtitle.innerText = "Create your secure account";
				mainBtn.innerText = "Complete Registration";
				passLabel.innerText = "Set Permanent Password";
				emailGroup.classList.remove('hidden'); // Ensure visible if coming from reset
				forgotLink.classList.add('hidden');
				altMethods.classList.add('hidden');
				toggleText.innerHTML = `Already have an account? <button onclick="toggleMode('login')" class="text-indigo-600 ml-1">Sign In</button>`;
			} else {
				subtitle.innerText = "Client & Admin Workspace";
				mainBtn.innerText = "Sign In with Password";
				passLabel.innerText = "Password";
				emailGroup.classList.remove('hidden'); // Ensure visible
				forgotLink.classList.remove('hidden');
				altMethods.classList.remove('hidden');
				toggleText.innerHTML = `New client? <button onclick="toggleMode('register')" class="text-indigo-600 ml-1">Register here</button>`;
			}
		}

        async function handleReset() {
			const email = document.getElementById('email').value;
			if (!email) { status.innerText = "âŒ Enter email first"; return; }
			status.innerText = "Sending Reset Email...";
			
			const { error } = await sb.auth.resetPasswordForEmail(email, {
				// CHANGE THIS: Point back to index.html so it can show the Reset UI
				redirectTo: window.location.origin + '/index.html', 
			});
			
			status.innerText = error ? "âŒ " + error.message : "âœ… Reset link sent to inbox!";
		}

        document.getElementById('mainBtn').onclick = async () => {
			const email = document.getElementById('email').value;
			const password = document.getElementById('password').value;

			// 1. HANDLE RESET MODE (Skip email check)
			if (mode === 'reset') {
				if (!password || password.length < 6) {
					status.innerText = "âŒ Password must be at least 6 characters";
					return;
				}
				status.innerText = "Updating...";
				
				const { error } = await sb.auth.updateUser({ password: password });
				
				if (error) {
					status.innerText = "âŒ " + error.message;
				} else {
					status.innerText = "âœ… Password Updated! Redirecting...";
					setTimeout(() => window.location.href = 'portal.html', 1500);
				}
				return; // Exit here so it doesn't run the checks below
			}

			// 2. HANDLE LOGIN/REGISTER (Requires both fields)
			if (!email || !password) {
				status.innerText = "âŒ Email and Password required";
				return;
			}

			status.innerText = "Processing...";

			if (mode === 'register') {
				const { error } = await sb.auth.signUp({
					email,
					password,
					options: { data: { is_admin: false } }
				});
				if (error) status.innerText = "âŒ " + error.message;
				else {
					status.innerText = "âœ… Account Created! Redirecting...";
					setTimeout(() => window.location.href = 'portal.html', 1500);
				}
			} else {
				const { error } = await sb.auth.signInWithPassword({ email, password });
				if (error) status.innerText = "âŒ " + error.message;
				else window.location.href = 'portal.html';
			}
		};

        document.getElementById('magicBtn').onclick = async () => {
            const email = document.getElementById('email').value;
            if (!email) { status.innerText = "âŒ Email required"; return; }
            status.innerText = "Sending Link...";
            const { error } = await sb.auth.signInWithOtp({
                email,
                options: { emailRedirectTo: window.location.origin + '/portal.html' }
            });
            status.innerText = error ? "âŒ " + error.message : "âœ… Check your email!";
        };

        document.getElementById('googleBtn').onclick = async () => {
            await sb.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: window.location.origin + '/portal.html' }
            });
        };
    </script>
</body>
</html>