<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nivas Kunj | Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&family=Inter:wght@400;500;600;700&display=swap');
        
        body { 
			font-family: 'Inter', sans-serif; 
			/* Deep Slate to Navy Mesh Gradient */
			background: radial-gradient(at 0% 0%, rgba(15, 23, 42, 1) 0, transparent 50%), 
						radial-gradient(at 100% 0%, rgba(30, 41, 59, 1) 0, transparent 50%), 
						radial-gradient(at 100% 100%, rgba(79, 70, 229, 0.1) 0, transparent 50%),
						radial-gradient(at 0% 100%, rgba(15, 23, 42, 1) 0, transparent 50%);
			background-color: #020617;
			background-attachment: fixed;
			color: #f8fafc;
			margin: 0;
		}

        /* Luxury Glass Panels */
        .glass-panel {
			background: rgba(30, 41, 59, 0.4); /* Darker transparency */
			backdrop-filter: blur(16px) saturate(180%);
			-webkit-backdrop-filter: blur(16px) saturate(180%);
			border: 1px solid rgba(255, 255, 255, 0.08);
			box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
		}

		.nav-blur {
			background: rgba(15, 23, 42, 0.8);
			backdrop-filter: blur(20px);
			border-bottom: 1px solid rgba(255, 255, 255, 0.05);
		}

        /* Active Tab Styling */
        .active-tab {
			background: rgba(79, 70, 229, 0.2) !important;
			color: #818cf8 !important; /* Lighter indigo for dark mode */
			border: 1px solid rgba(129, 140, 248, 0.3);
		}

        .btn-luxury {
			background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
			box-shadow: 0 0 20px rgba(79, 70, 229, 0.4);
			border: none;
		}

		.btn-luxury:hover {
			box-shadow: 0 0 30px rgba(124, 58, 237, 0.6);
			transform: translateY(-2px) scale(1.02);
		}

        .hidden { display: none !important; }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up { animation: slideUp 0.5s ease-out forwards; }

        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
		/* Modern scrollbar for the Discussion Modal */
		.custom-scrollbar::-webkit-scrollbar {
			width: 4px;
		}
		.custom-scrollbar::-webkit-scrollbar-track {
			background: rgba(255, 255, 255, 0.02);
			border-radius: 10px;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb {
			background: rgba(99, 102, 241, 0.2);
			border-radius: 10px;
		}
		.custom-scrollbar::-webkit-scrollbar-thumb:hover {
			background: rgba(99, 102, 241, 0.5);
		}
		/* Chat Bubble Styling */
		.custom-scrollbar {
			scroll-behavior: smooth;
		}

		/* Add a slight entrance animation to bubbles */
		.flex.justify-start, .flex.justify-end {
			animation: bubbleFadeIn 0.3s ease-out forwards;
		}

		@keyframes bubbleFadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}
		.toast-visible {
			transform: translate(-50%, -20px) !important;
			opacity: 1 !important;
		}
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-zinc-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p class="text-zinc-500 font-bold text-[10px] uppercase tracking-[0.3em]">Authenticating</p>
    </div>

    <div id="admin-view" class="hidden min-h-screen">
        <nav class="h-20 nav-blur px-8 lg:px-12 flex items-center justify-between sticky top-0 z-50">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <img src="https://github.com/ranadeep-banik137/NivasKunjInteriors/blob/main/logo%20transparent%20PNG.png?raw=true" class="h-6 w-auto" alt="Logo">
                </div>
                <div>
                    <h1 class="font-bold text-sm tracking-tighter text-white uppercase leading-none">Nivas Kunj</h1>
                    <p class="text-[8px] font-black text-indigo-600 uppercase tracking-widest mt-1">Luxury Interiors</p>
                </div>
            </div>

            <div class="flex items-center bg-white/5 p-1.5 rounded-2xl border border-white/10 backdrop-blur-md">
                <button onclick="switchTab('enquiries')" id="tab-enquiries" 
                    class="px-6 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all duration-300 flex items-center gap-2 active-tab">
                    <i data-lucide="users" class="w-3.5 h-3.5"></i> Enquiries
                </button>
                <button onclick="switchTab('quotes')" id="tab-quotes" 
                    class="px-6 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all duration-300 flex items-center gap-2">
                    <i data-lucide="file-text" class="w-3.5 h-3.5"></i> Quotes
                </button>
				<button onclick="switchTab('projects')" id="tab-projects" 
					class="px-6 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest transition-all duration-300 flex items-center gap-2">
					<i data-lucide="layout-dashboard" class="w-3.5 h-3.5"></i> Projects
				</button>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex items-center gap-3 px-4 py-2 bg-slate-900/50 border border-white/10 rounded-2xl shadow-sm">
                    <div class="w-8 h-8 rounded-full bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                        <i data-lucide="user-check" class="w-4 h-4"></i>
                    </div>
                    <div class="flex flex-col items-start">
                        <span class="text-[8px] font-black text-slate-500 uppercase tracking-tighter leading-none">Access Level</span>
                        <span id="user-role" class="text-[10px] font-bold text-indigo-400 uppercase">Administrator</span>
                    </div>
                </div>
                <button onclick="handleLogout()" class="w-11 h-11 flex items-center justify-center rounded-2xl bg-slate-900 text-white hover:bg-red-600 transition-all shadow-lg active:scale-95">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </nav>
		
		<main class="max-w-7xl mx-auto px-8 lg:px-12 py-12">
			<header class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
				<div>
					<h2 id="tab-title" class="text-3xl font-black text-white tracking-tighter uppercase">Enquiry Pipeline</h2>
					<p class="text-slate-400 text-xs font-medium mt-1">Manage and track high-intent workspace enquiries.</p>
				</div>
				
				<div class="flex flex-wrap items-center gap-3">
					<div class="relative">
						<i data-lucide="search" class="w-4 h-4 absolute left-4 top-1/2 -translate-y-1/2 text-slate-500"></i>
						<input type="text" id="leadSearch" oninput="handleSearch()" placeholder="Search client or email..." 
							class="bg-white/5 border border-white/10 rounded-2xl py-3 pl-11 pr-4 text-xs font-bold text-white outline-none focus:ring-2 focus:ring-indigo-500 w-64 transition-all">
					</div>

					<select id="sortOrder" onchange="handleSort()" class="bg-white/5 border border-white/10 rounded-2xl py-3 px-4 text-[10px] font-black uppercase text-slate-400 outline-none cursor-pointer">
						<option value="newest">Newest First</option>
						<option value="oldest">Oldest First</option>
						<option value="name">Name A-Z</option>
					</select>

					<button onclick="fetchAdminData()" class="w-11 h-11 flex items-center justify-center bg-white/5 border border-white/10 rounded-2xl text-white hover:bg-indigo-600 transition shadow-sm">
						<i data-lucide="refresh-cw" class="w-4 h-4"></i>
					</button>
				</div>
			</header>

			<div class="grid grid-cols-12 px-8 mb-6 text-[9px] font-black uppercase text-slate-400 tracking-[0.2em]">
				<div class="col-span-4">Customer Identity</div>
				<div class="col-span-3">Pipeline Status</div>
				<div class="col-span-2">Verification</div>
				<div class="col-span-3 text-right">Action</div>
			</div>

			<div id="pagination-controls" class="mt-8 flex justify-center items-center gap-4">
				</div>
			<div id="enquiries-view" class="tab-content">
				<div id="admin-content" class="space-y-4"></div>
			</div>

			<div id="projects-view" class="tab-content hidden">
				<div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
					</div>
			</div>
		</main>
	</div>

    <div id="lead-modal" class="fixed inset-0 bg-slate-950/60 backdrop-blur-md z-[400] hidden flex items-center justify-center p-4">
        <div class="bg-slate-950 w-full max-w-4xl max-h-[92vh] rounded-[40px] shadow-2xl border border-white/10 flex flex-col overflow-hidden animate-slide-up">
            <div class="bg-slate-950 w-full max-w-5xl max-h-[95vh] rounded-[32px] shadow-2xl border border-white/10 flex flex-col overflow-hidden animate-slide-up">
				<div class="p-6 border-b border-white/10 flex justify-between items-center bg-slate-900">
					<div>
						<h3 id="modal-title" class="text-xl font-black text-white tracking-tighter uppercase">Lead Workspace</h3>
						<p id="modal-subtitle" class="text-slate-400 text-[10px] font-medium mt-1"></p>
					</div>
					<button onclick="closeModal()" class="w-10 h-10 flex items-center justify-center bg-white/5 hover:bg-red-500/20 text-slate-400 rounded-xl transition">
						<i data-lucide="x" class="w-5 h-5"></i>
					</button>
				</div>

				<div class="flex-1 overflow-y-auto p-6">
					<div id="modal-body-content" class="space-y-6"></div>
				</div>
			</div>

            <div class="p-10 border-t bg-slate-50/50 flex justify-end gap-6">
                <button onclick="closeModal()" class="text-[10px] font-bold text-slate-400 hover:text-white transition uppercase tracking-widest">Close Workspace</button>
                <button id="save-btn" class="px-12 py-5 bg-slate-900 text-white text-[10px] font-bold rounded-2xl hover:bg-indigo-600 transition shadow-xl uppercase tracking-[0.2em]">Save All Changes</button>
            </div>
        </div>
    </div>

    <div id="client-view" class="hidden min-h-screen bg-[#020617] text-white">
		<nav class="h-20 border-b border-white/5 bg-slate-900/50 backdrop-blur-xl px-8 flex items-center justify-between sticky top-0 z-50">
			<div class="flex items-center gap-4">
				<div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center shadow-lg shadow-indigo-500/20">
					<img src="https://github.com/ranadeep-banik137/NivasKunjInteriors/blob/main/logo%20transparent%20PNG.png?raw=true" class="h-6 w-auto" alt="Logo">
				</div>
				<div>
					<h1 class="font-bold text-sm tracking-tighter uppercase leading-none">Nivas Kunj</h1>
					<p class="text-[8px] font-black text-indigo-400 uppercase tracking-widest mt-1">Client Activity Portal</p>
				</div>
			</div>

			<div class="flex items-center gap-6">
				<div class="hidden md:block text-right">
					<p id="client-display-email" class="text-[10px] font-bold text-slate-400 italic"></p>
					<p class="text-[8px] font-black text-emerald-500 uppercase tracking-widest">Logged In</p>
				</div>
				<button onclick="handleLogout()" class="w-11 h-11 flex items-center justify-center rounded-2xl bg-white/5 border border-white/10 hover:bg-red-500/20 hover:text-red-500 transition-all">
					<i data-lucide="log-out" class="w-5 h-5"></i>
				</button>
			</div>
		</nav>

		<main class="max-w-6xl mx-auto px-8 py-12">
			<header class="mb-12">
				<h2 class="text-4xl font-black tracking-tighter uppercase mb-2">Activity Log</h2>
				<p class="text-slate-500 text-xs font-medium uppercase tracking-widest">Tracking your architectural enquiries & design requests</p>
			</header>

			<div id="client-activity-content" class="space-y-4">
				</div>
		</main>
	</div>

    <script>
		let currentProjectId = null;
		let allLeads = []; // Holds all fetched data
		let filteredLeads = []; // Holds search/filtered results
		let currentPage = 1;
		const itemsPerPage = 8; // Increased from 3-4 to 8 for better density
		let currentTab = 'enquiries';
        const S_URL = 'https://wbhcvcsdpdandaxidnlg.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiaGN2Y3NkcGRhbmRheGlkbmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjMwMjksImV4cCI6MjA4MTUzOTAyOX0.n8R1OpFxilWbDfteODc-lyVF_qvntyRnJNVM3g9xCWs'; 
        const sb = supabase.createClient(S_URL, S_KEY);
		
		async function initializeAuth() {
			const loader = document.getElementById('loader');
			const { data: { user }, error: authError } = await sb.auth.getUser();

			if (authError || !user) {
				window.location.href = 'index.html';
				return;
			}
			
			const initialSessionId = user.id;
			
			// 2. Watch for session changes (Collision Detection)
			sb.auth.onAuthStateChange((event, session) => {
				if (event === 'SIGNED_OUT' || !session) {
					window.location.href = 'index.html';
				} else if (session.user.id !== initialSessionId) {
					// Identity Theft Detection: If the ID in storage changed to User B, kill this tab
					alert("Security: Another user has logged in. Closing session.");
					window.location.href = 'index.html';
				}
			});
			
			window.userSession = {
				id: user.id,
				email: user.email
			};
			
			try {
				const { data: profile, error: profileError } = await sb
					.from('profiles')
					.select('is_admin, email')
					.eq('id', user.id)
					.single();

				if (profileError || !profile) {
					await sb.auth.signOut();
					window.location.href = 'index.html';
					return;
				}
				
				window.currentUserProfile = profile

				if (loader) loader.classList.add('hidden');

				if (profile.is_admin) {
					document.getElementById('admin-view').classList.remove('hidden');
					fetchAdminData();
				} else {
					document.getElementById('client-view').classList.remove('hidden');
					initializeClientDashboard(profile.email);
				}
			} catch (err) {
				window.location.href = 'index.html';
			}
		}

		initializeAuth();

		sb.auth.onAuthStateChange((event) => {
			if (event === 'SIGNED_OUT') window.location.href = 'index.html';
		});
		
		async function fetchAdminData() {
			if (currentTab === 'projects') {
				loadAdminProjects();
				return;
			}

			const container = document.getElementById('admin-content');
			container.innerHTML = `<div class="p-20 text-center animate-pulse text-slate-400 font-bold text-[10px] uppercase tracking-widest">Syncing Pipeline...</div>`;
			
			const isQuoteFilter = currentTab === 'quotes';
			const [rawRes, custRes, detRes, statRes] = await Promise.all([
				sb.from('raw_enquiries').select('*').eq('is_quote', isQuoteFilter),
				sb.from('customer_details').select('*'),
				sb.from('enquiry_details').select('*'),
				sb.from('enquiry_status').select('*')
			]);

			if (rawRes.error) { container.innerHTML = "Error loading data"; return; }

			// Map all data into the global allLeads array
			allLeads = rawRes.data.map(lead => ({
				...lead,
				customer: custRes.data?.find(c => c.enquiry_id === lead.id) || {},
				detail: detRes.data?.find(d => d.enquiry_id === lead.id) || {},
				statusLabel: statRes.data?.find(s => s.status_id === (detRes.data?.find(d => d.enquiry_id === lead.id)?.status_id))?.status_details || 'New'
			}));

			filteredLeads = [...allLeads]; // CRITICAL: Initialize this so renderTable works
			renderTable(); 
		}

		function handleSearch() {
			searchQuery = document.getElementById('leadSearch').value.toLowerCase();
			currentPage = 1; 

			if (currentTab === 'projects') {
				loadAdminProjects(); // Project search is server-side (Supabase)
			} else {
				// Enquiry/Quote search is client-side (Filtering local array)
				filteredLeads = allLeads.filter(lead => 
					(lead.customer?.customer_name?.toLowerCase().includes(searchQuery)) ||
					(lead.customer?.email_id?.toLowerCase().includes(searchQuery)) ||
					(lead.project_name?.toLowerCase().includes(searchQuery))
				);
				renderTable(); 
			}
		}

		function handleSort() {
			sortBy = document.getElementById('sortOrder').value;
			currentPage = 1;

			if (currentTab === 'projects') {
				loadAdminProjects();
			} else {
				// Sort the leads array based on selection
				if (sortBy === 'newest') allLeads.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
				else if (sortBy === 'oldest') allLeads.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
				
				filteredLeads = [...allLeads];
				handleSearch(); // Re-apply search filter after sorting
			}
		}

		// 5. Pagination and Table Rendering
		function renderTable() {
			const container = document.getElementById('admin-content');
			const start = (currentPage - 1) * itemsPerPage;
			const end = start + itemsPerPage;
			const paginatedItems = filteredLeads.slice(start, end);

			if (paginatedItems.length === 0) {
				container.innerHTML = `<div class="p-20 text-center text-slate-400 uppercase font-bold text-[10px] tracking-widest">No Matches Found</div>`;
				renderPagination();
				return;
			}

			container.innerHTML = paginatedItems.map(lead => `
				<div class="animate-slide-up glass-panel grid grid-cols-12 items-center p-4 px-8 rounded-2xl group hover:border-indigo-500/50 transition-all duration-300">
					<div class="col-span-4">
						<div class="flex items-center gap-4">
							<div class="w-10 h-10 rounded-xl bg-slate-900 border border-white/5 flex items-center justify-center text-white font-bold text-sm">
								${lead.customer.customer_name ? lead.customer.customer_name.charAt(0) : '?'}
							</div>
							<div>
								<h3 class="font-bold text-white text-sm tracking-tight">${lead.customer.customer_name || 'Anonymous'}</h3>
								<p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest leading-none mt-1">${lead.customer.email_id || lead.email_id}</p>
							</div>
						</div>
					</div>
					<div class="col-span-3">
						<span class="px-3 py-1 bg-indigo-500/10 border border-indigo-500/20 text-indigo-400 text-[9px] font-black rounded-lg uppercase">
							${lead.statusLabel}
						</span>
					</div>
					<div class="col-span-2 flex gap-2">
						${lead.customer.is_member ? '<i data-lucide="shield-check" class="w-4 h-4 text-indigo-400"></i>' : ''}
					</div>
					<div class="col-span-3 text-right">
						<button onclick="manageLead('${lead.id}')" class="bg-white/5 hover:bg-indigo-600 border border-white/10 text-white px-5 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all">
							Manage
						</button>
					</div>
				</div>
			`).join('');

			renderPagination();
			lucide.createIcons();
		}

		function renderPagination() {
			const pg = document.getElementById('pagination-controls');
			const totalPages = Math.ceil(filteredLeads.length / itemsPerPage);
			
			if (totalPages <= 1) { pg.innerHTML = ''; return; }

			pg.innerHTML = `
				<button onclick="changePage(-1)" ${currentPage === 1 ? 'disabled' : ''} class="p-2 text-slate-500 hover:text-white disabled:opacity-20 transition"><i data-lucide="chevron-left"></i></button>
				<span class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Page ${currentPage} of ${totalPages}</span>
				<button onclick="changePage(1)" ${currentPage === totalPages ? 'disabled' : ''} class="p-2 text-slate-500 hover:text-white disabled:opacity-20 transition"><i data-lucide="chevron-right"></i></button>
			`;
			lucide.createIcons();
		}

		function changePage(step) {
			currentPage += step;
			renderTable();
			window.scrollTo({ top: 0, behavior: 'smooth' });
		}

		async function manageLead(leadId) {
			const modal = document.getElementById('lead-modal');
			const content = document.getElementById('modal-body-content');
			modal.classList.remove('hidden');
			content.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 text-[10px] font-bold uppercase tracking-widest">Initializing Workspace...</div>`;

			const [leadRes, custRes, detRes, commRes, statRes, quoteRes, imagesRes] = await Promise.all([
				sb.from('raw_enquiries').select('*').eq('id', leadId).single(),
				sb.from('customer_details').select('*').eq('enquiry_id', leadId).single(),
				sb.from('enquiry_details').select('*').eq('enquiry_id', leadId).single(),
				sb.from('enquiry_comments').select('*').eq('enquiry_id', leadId).order('created_at', { ascending: false }),
				sb.from('enquiry_status').select('*'),
				sb.from('quote_details').select('*').eq('enquiry_id', leadId).maybeSingle(),
				sb.from('quote_images').select('image_url').eq('enquiry_id', leadId)
			]);
			
			const lead = leadRes.data;
			const customer = custRes.data;
			const details = detRes.data;
			const email = customer?.email_id || lead?.email_id;
			const quote = quoteRes.data;
			const images = imagesRes.data || [];
			const currentProjectId = details.project_id
			//const { data: profile } = await sb.from('profiles').select('*').eq('email', email).single();
			//const isRegistered = !!profile;
			
			const { data: profileData, error: profileError } = await sb
				.from('profiles')
				.select('id')
				.eq('email', email);
			const isRegistered = profileData && profileData.length > 0;
			
			
			document.getElementById('modal-title').innerText = `${customer?.customer_name || 'New Lead'} - Query`;
			document.getElementById('modal-subtitle').innerText = lead.query_data;

			content.innerHTML = `
				<div class="p-5 bg-slate-900 rounded-2xl text-white border border-white/5 flex items-center justify-between">
					<div class="flex items-center gap-4">
						<div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400">
							<i data-lucide="${isRegistered ? 'shield-check' : 'user-plus'}" class="w-5 h-5"></i>
						</div>
						<div>
							<p class="text-[8px] font-black text-indigo-400 uppercase tracking-widest leading-none mb-1">Security Status</p>
							<h4 class="text-sm font-bold">${isRegistered ? 'Verified Client' : 'External Lead'}</h4>
						</div>
					</div>
					<div class="text-right">
						<p class="text-[8px] text-white/40 font-bold uppercase tracking-widest mb-1">Linked Email</p>
						<p class="text-xs font-medium">${email}</p>
					</div>
				</div>

				<div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-slate-900/40 rounded-2xl border border-white/5">
					<div class="space-y-1.5">
						<label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-1">Customer Name</label>
						<input id="edit-name" type="text" value="${customer?.customer_name || ''}" 
						class="w-full px-4 py-2.5 bg-slate-950 border border-white/10 rounded-xl text-xs font-bold text-white outline-none focus:ring-1 focus:ring-indigo-500">
					</div>
					<div class="space-y-1.5">
						<label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-1">Phone Number</label>
						<input id="edit-phone" type="text" value="${customer?.phone_number || ''}" 
						class="w-full px-4 py-2.5 bg-slate-950 border border-white/10 rounded-xl text-xs font-bold text-white outline-none focus:ring-1 focus:ring-indigo-500">
					</div>
					<div class="space-y-1.5">
						<label class="text-[8px] font-black text-slate-500 uppercase tracking-widest ml-1">Pipeline Status</label>
						<select id="edit-status" class="w-full px-4 py-2.5 bg-slate-950 border border-white/10 rounded-xl text-xs font-bold text-white outline-none focus:ring-1 focus:ring-indigo-500">
							${statRes.data.map(s => `<option value="${s.status_id}" ${details?.status_id === s.status_id ? 'selected' : ''}>${s.status_details}</option>`).join('')}
						</select>
					</div>
				</div>
				
				${getQuoteHTML(quote, images)}

				<div class="space-y-4">
					<div class="flex items-center justify-between px-2">
						<h4 class="text-[9px] font-black text-slate-400 uppercase tracking-[0.2em]">Interaction History</h4>
						<div class="flex gap-2 w-2/3">
							<input id="new-comment" placeholder="Log internal note..." class="flex-1 px-4 py-2 bg-slate-900 border border-white/10 rounded-xl text-xs text-white outline-none">
							<button onclick="addComment('${leadId}')" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-[9px] font-black uppercase hover:bg-indigo-500 transition">Post</button>
						</div>
					</div>
					
					<div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-48 overflow-y-auto pr-2">
						${commRes.data?.length > 0 ? commRes.data.map(c => {
							const isAdminNote = c.org_comments !== null && c.org_comments !== '';
							const noteText = isAdminNote ? c.org_comments : c.comments;
							
							return `
								<div class="p-4 rounded-xl ${isAdminNote ? 'bg-amber-500/10 border border-amber-500/20' : 'bg-white/5 border border-white/5'}">
									<div class="flex justify-between items-center mb-1">
										<span class="text-[8px] font-black uppercase tracking-widest ${isAdminNote ? 'text-amber-500' : 'text-indigo-400'}">
											${isAdminNote ? 'Admin Note' : 'Client Message'}
										</span>
										<span class="text-[8px] text-slate-500 font-medium">${new Date(c.created_at).toLocaleDateString()}</span>
									</div>
									<p class="text-[11px] text-slate-300 leading-snug">${noteText}</p>
								</div>
							`;
						}).join('') : '<p class="text-[10px] text-slate-500 italic col-span-2 text-center py-4">No interactions recorded.</p>'}
					</div>
				</div>
			
				${details?.is_project ? `
					<div class="mt-8 p-5 bg-emerald-500/10 border border-emerald-500/20 rounded-2xl flex items-center justify-between">
						<div class="flex items-center gap-3">
							<div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center text-emerald-400">
								<i data-lucide="check-circle" class="w-5 h-5"></i>
							</div>
							<div>
								<h4 class="text-xs font-black text-white uppercase tracking-tight">Active Project Linked</h4>
								<p class="text-[9px] text-emerald-300/60 font-medium">Project ID: ${details.project_id.slice(0,8)}... is live.</p>
							</div>
						</div>
						<button onclick="goToProjectFromEnquiry('${details.project_id}')" 
								class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-[9px] font-black uppercase tracking-widest transition-all flex items-center gap-2 group">
							Go to Project Workspace
							<i data-lucide="arrow-right" class="w-3 h-3 group-hover:translate-x-1 transition-transform"></i>
						</button>
					</div>
				` : `
					<div id="onboarding-zone" class="mt-8">
						<div class="p-5 bg-indigo-600/10 border border-indigo-500/20 rounded-2xl flex flex-col md:flex-row items-center justify-between gap-4">
							<div class="flex items-center gap-3">
								<div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400">
									<i data-lucide="layers" class="w-5 h-5"></i>
								</div>
								<div>
									<h4 class="text-xs font-black text-white uppercase tracking-tight">Cluster Management</h4>
									<p class="text-[9px] text-indigo-300/60 font-medium">Scan for other enquiries from this client to group them.</p>
								</div>
							</div>
							<button onclick="searchSiblingsForOnboarding('${leadId}', '${email}')" 
								class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white text-[10px] font-black uppercase tracking-widest rounded-xl transition-all shadow-lg shadow-indigo-500/20">
								Scan for Related Items
							</button>
						</div>
					</div>
				`}

				${(!isRegistered && !details?.is_project) ? `
				<div class="mt-3 px-4 py-3 bg-white/5 border border-white/5 rounded-xl flex items-center justify-between">
					<p class="text-[9px] text-slate-400 font-medium">Client hasn't joined the portal yet.</p>
					<button onclick="sendRegistrationInvite('${email}', '${customer?.customer_name}')" 
						class="text-[9px] font-black text-indigo-400 uppercase tracking-widest hover:text-white transition">
						Send Invite &rarr;
					</button>
				</div>
				` : ''}
			`; // End of content.innerHTML template
			lucide.createIcons();
			document.getElementById('save-btn').onclick = () => saveLeadChanges(leadId);
		}
		
		function switchTab(tab) {
			currentTab = tab;
			
			// 1. Handle UI Highlighting
			document.querySelectorAll('[id^="tab-"]').forEach(btn => btn.classList.remove('active-tab'));
			document.getElementById(`tab-${tab}`).classList.add('active-tab');

			// 2. Handle Title and Container Visibility
			const titles = {
				'enquiries': 'Enquiry Pipeline',
				'quotes': 'Active Quotations',
				'projects': 'Project Dashboard'
			};
			document.getElementById('tab-title').innerText = titles[tab];

			const enquiriesView = document.getElementById('enquiries-view');
			const projectsView = document.getElementById('projects-view');

			if (tab === 'projects') {
				enquiriesView.classList.add('hidden');
				projectsView.classList.remove('hidden');
				loadAdminProjects(); // Load project-specific data
			} else {
				projectsView.classList.add('hidden');
				enquiriesView.classList.remove('hidden');
				fetchAdminData(); // Existing logic for Enquiries/Quotes
			}
		}

		async function searchSiblingsForOnboarding(primaryId, email) {
			const zone = document.getElementById('onboarding-zone');
			zone.innerHTML = `<div class="py-10 animate-pulse text-slate-400 text-[10px] font-black uppercase tracking-widest text-center">Scanning Cluster...</div>`;

			try {
				const { data: customerEntries } = await sb.from('customer_details').select('enquiry_id').eq('email_id', email);
				const allEnquiryIds = customerEntries.map(ce => ce.enquiry_id);
				const { data: siblings } = await sb.from('raw_enquiries')
					.select(`id, created_at, query_data, customer_details(customer_name)`)
					.in('id', allEnquiryIds);

				const otherLeads = siblings.filter(s => s.id !== primaryId);

				zone.innerHTML = `
					<div class="text-left bg-slate-900/50 p-6 rounded-2xl border border-white/10 shadow-xl">
						<div class="flex justify-between items-center mb-6">
							<div>
								<h4 class="text-xs font-black text-white tracking-tight uppercase">Cluster Identification</h4>
								<p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1">Found ${otherLeads.length} related records for this email</p>
							</div>
							<button onclick="toggleAllSiblings(this)" class="px-4 py-1.5 bg-white/5 border border-white/10 rounded-lg text-[8px] font-black text-indigo-400 uppercase hover:bg-white/10 transition">Select All</button>
						</div>

						<div class="space-y-2 max-h-48 overflow-y-auto mb-6 pr-2 custom-scrollbar">
							<div class="p-3 bg-indigo-500/10 border border-indigo-500/20 rounded-xl flex items-center gap-4">
								<input type="checkbox" checked disabled class="w-4 h-4 accent-indigo-400 opacity-50">
								<div class="flex-1 grid grid-cols-2 text-[9px] font-bold text-white uppercase tracking-widest items-center">
									<span class="truncate">Current Master Lead</span>
									<span class="text-right text-indigo-400">Primary</span>
								</div>
							</div>

							${otherLeads.map(s => `
								<div class="p-3 bg-white/5 border border-white/5 rounded-xl flex items-center gap-4 hover:border-indigo-500/30 transition group">
									<input type="checkbox" class="sibling-checkbox w-4 h-4 accent-indigo-600" value="${s.id}" checked>
									<div class="flex-1 grid grid-cols-2 text-[9px] font-bold text-slate-300 uppercase tracking-widest items-center">
										<span class="truncate">Enquiry: ${new Date(s.created_at).toLocaleDateString()}</span>
										<span class="text-right text-slate-500 group-hover:text-indigo-400">ID: ${s.id.slice(0,8)}</span>
									</div>
								</div>
							`).join('')}
						</div>

						<div class="flex flex-col gap-3">
							<input id="project-name" type="text" placeholder="Assign Global Project Name..." 
								class="w-full px-4 py-2.5 bg-slate-950 border border-white/10 rounded-xl text-[11px] font-bold text-white outline-none focus:ring-1 focus:ring-indigo-500">
							<button onclick="executeBulkOnboarding('${primaryId}', '${email}')" 
								class="w-full py-3 bg-indigo-600 text-white rounded-xl text-[10px] font-black uppercase tracking-[0.2em] hover:bg-indigo-500 transition shadow-lg shadow-indigo-500/20">
								Confirm & Launch Project
							</button>
						</div>
					</div>
				`;
				lucide.createIcons();
			} catch (err) { zone.innerHTML = `<p class="text-[9px] text-red-400 text-center uppercase font-black">Cluster Scan Failed</p>`; }
		}
		
		function goToProjectFromEnquiry(projectId) {
			// 1. Close the Lead/Enquiry Modal
			const leadModal = document.getElementById('lead-modal');
			if (leadModal) leadModal.classList.add('hidden');

			// 2. Switch the main view to 'projects'
			switchTab('projects');

			// 3. Open the specific project workspace
			// We wrap this in a tiny timeout to ensure the view switch completes
			setTimeout(() => {
				openProjectWorkspace(projectId);
				
				// Success feedback
				if (typeof showToast === 'function') {
					showToast("Navigated to Project Workspace", "success");
				}
			}, 100);
		}
		
		async function executeBulkOnboarding(primaryId, email) {
			const zone = document.getElementById('onboarding-zone');
			const customerName = document.getElementById('edit-name').value || "New Client";
			const newProjectId = crypto.randomUUID();
			const checkboxes = document.querySelectorAll('.sibling-checkbox:checked');
			const idsToLink = [primaryId, ...Array.from(checkboxes).map(cb => cb.value)];

			zone.innerHTML = `<div class="py-10 text-slate-400 text-[10px] font-black animate-pulse uppercase">Allocating Workspace ID...</div>`;

			try {
				await sb.from('projects').insert({
					id: newProjectId,
					enquiry_id: primaryId,
					project_name: customerName.trim() + "'s Project",
					current_phase: 'Onboarding',
					client_email: email
				});

				await sb.from('enquiry_details').update({ project_id: newProjectId, is_project: true, status_id: 5 }).in('enquiry_id', idsToLink);
				
				alert(`PROJECT LIVE: ${newProjectId.slice(0,8)} created.`);
				closeModal();
				fetchAdminData();
			} catch (err) { alert("Execution failed."); searchSiblingsForOnboarding(primaryId, email); }
		}

		async function saveLeadChanges(leadId) {
			const saveBtn = document.getElementById('save-btn');
			const name = document.getElementById('edit-name').value;
			const phone = document.getElementById('edit-phone').value;
			const statusId = document.getElementById('edit-status').value;

			saveBtn.disabled = true;
			saveBtn.innerText = "SYNCING...";

			await Promise.all([
				sb.from('customer_details').update({ customer_name: name, phone_number: phone }).eq('enquiry_id', leadId),
				sb.from('enquiry_details').update({ status_id: statusId }).eq('enquiry_id', leadId)
			]);
			
			saveBtn.innerText = "VERIFIED!";
			setTimeout(() => {
				closeModal();
				fetchAdminData();
				saveBtn.innerText = "Save All Changes";
				saveBtn.disabled = false;
			}, 1000);
		}

		async function addComment(leadId) {
			const commentText = document.getElementById('new-comment').value;
			if (!commentText.trim()) return;
			
			try {
				const isAdmin = window.currentUserProfile.is_admin === true;
				const payload = {
					enquiry_id: leadId,
				};
				
				if (isAdmin) {
					payload.org_comments = commentText; // Admin/Internal column
					payload.comments = null;
				} else {
					payload.comments = commentText;     // Client/External column
					payload.org_comments = null;
				}
				
				//await sb.from('enquiry_comments').insert({ enquiry_id: leadId, comments: commentText, org_comments: "Admin Note" });
				const { error } = await sb.from('enquiry_comments').insert([payload]);
				if (error) throw error;
				manageLead(leadId);
			} catch (err) {
				console.error('Error adding enquiry comment:', err);
			}
		}

		function getQuoteHTML(q, images) {
			if (!q) return '';
			return `
				<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
					<div class="p-4 bg-slate-900/50 border border-white/5 rounded-2xl">
						<p class="text-[7px] font-black text-slate-500 uppercase tracking-widest mb-1">Flat Type</p>
						<p class="text-xs font-bold text-white">${q.flat_type}</p>
					</div>
					<div class="p-4 bg-slate-900/50 border border-white/5 rounded-2xl">
						<p class="text-[7px] font-black text-slate-500 uppercase tracking-widest mb-1">Bedrooms</p>
						<p class="text-xs font-bold text-white">${q.bedrooms} BHK</p>
					</div>
					<div class="p-4 bg-slate-900/50 border border-white/5 rounded-2xl">
						<p class="text-[7px] font-black text-slate-500 uppercase tracking-widest mb-1">Area</p>
						<p class="text-xs font-bold text-white">${q.area_sqft} Sqft</p>
					</div>
					<div class="p-4 bg-indigo-500/10 border border-indigo-500/20 rounded-2xl">
						<p class="text-[7px] font-black text-indigo-400 uppercase tracking-widest mb-1">Package</p>
						<p class="text-xs font-bold text-indigo-300">${q.package}</p>
					</div>
				</div>
				${images.length > 0 ? `
					<div class="flex gap-2 overflow-x-auto py-2 scrollbar-hide">
						${images.map(img => `
							<img src="${img.image_url}" class="h-16 w-16 object-cover rounded-lg border border-white/10 flex-shrink-0">
						`).join('')}
					</div>
				` : ''}
			`;
		}

		async function initializeClientDashboard(email) {
			const container = document.getElementById('client-activity-content');
			container.innerHTML = `<div class="py-20 text-center animate-pulse text-slate-400 font-bold text-[10px] uppercase tracking-widest">Loading Projects...</div>`;

			try {
				// Step 1: Fetch Projects for this client
				const { data: projects, error: pError } = await sb
					.from('projects')
					.select('*')
					.eq('client_email', email);

				if (pError || !projects.length) {
					container.innerHTML = `<div class="p-20 glass-panel rounded-3xl text-center text-slate-500 uppercase font-bold text-xs tracking-widest border border-dashed border-white/10">No active projects found.</div>`;
					return;
				}

				// Step 2: Render Project Cards
				container.innerHTML = projects.map(proj => `
					<div class="glass-panel p-8 rounded-[32px] border border-white/10 mb-6 hover:border-indigo-500/30 transition-all">
						<div class="flex flex-col lg:flex-row justify-between gap-6 mb-8">
							<div>
								<div class="flex items-center gap-3 mb-2">
									<span class="px-3 py-1 bg-indigo-500/20 text-indigo-400 text-[9px] font-black uppercase rounded-lg tracking-widest">Project ID: ${proj.id.slice(0,8)}</span>
									<span class="text-slate-500 text-[9px] font-bold uppercase">${new Date(proj.created_at).toLocaleDateString()}</span>
								</div>
								<h2 class="text-3xl font-black text-white tracking-tighter uppercase">${proj.project_name}</h2>
							</div>
							<div class="text-right">
								<p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Current Status</p>
								<span class="text-xl font-bold text-emerald-400 uppercase tracking-tighter">${proj.current_phase}</span>
							</div>
						</div>

						<div class="mb-8">
							<div class="flex justify-between items-end mb-2">
								<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Completion Progress</span>
								<span class="text-lg font-black text-white">${proj.progress_percent || 0}%</span>
							</div>
							<div class="w-full h-3 bg-white/5 rounded-full overflow-hidden border border-white/5">
								<div class="h-full bg-gradient-to-r from-indigo-600 to-emerald-500 transition-all duration-1000" style="width: ${proj.progress_percent || 0}%"></div>
							</div>
						</div>

						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<button onclick="openProjectWorkspace('${proj.id}')" class="btn-luxury py-4 rounded-2xl text-[10px] font-black uppercase tracking-[0.2em] text-white">
								Enter Project Workspace
							</button>
							<div class="flex gap-2">
								<button onclick="initiateProjectCall('${proj.id}')" class="flex-1 bg-white/5 hover:bg-white/10 border border-white/10 py-4 rounded-2xl text-[10px] font-black uppercase text-white transition flex items-center justify-center gap-2">
									<i data-lucide="phone" class="w-4 h-4"></i> Call Team
								</button>
							</div>
						</div>
					</div>
				`).join('');

				lucide.createIcons();
			} catch (err) {
				container.innerHTML = "Error syncing project data.";
			}
		}
		
		let activeProjectId = null;
		let activeEnquiryIds = []; // Global to keep track of IDs for messaging

		async function openProjectWorkspace(projectId) {
			activeProjectId = projectId;
			const workspace = document.getElementById('project-workspace');
			workspace.classList.remove('hidden');
			document.body.style.overflow = 'hidden';
			try {
				// 1. Fetch Project Core Data
				const { data: proj } = await sb.from('projects').select('*').eq('id', projectId).single();
				
				// 1. Define the standard phase sequence
				const phases = ['Initiation', 'Design Concept', 'Procurement', 'Installation', 'Handover'];

				// 2. Clean the DB value for comparison (removing spaces and making lowercase)
				const dbPhase = (proj.current_phase || "").trim().toLowerCase();

				// 3. Find which index we are currently at
				const currentIdx = phases.findIndex(p => p.toLowerCase() === dbPhase);
				
				
				// 4. Render the UI
				document.getElementById('luxury-timeline').innerHTML = phases.map((phase, i) => {
					const isCompleted = i < currentIdx;
					const isActive = i === currentIdx;
					
					return `
						<div class="relative pl-12 mb-10 last:mb-0">
							${i !== phases.length - 1 ? `
								<div class="absolute left-[15px] top-8 w-[2px] h-full 
									${i < currentIdx ? 'bg-indigo-500' : 'bg-white/5'}"></div>
							` : ''}

							<div class="absolute left-0 top-0 w-8 h-8 rounded-full border-2 z-10 flex items-center justify-center transition-all duration-700 
								${isCompleted ? 'bg-indigo-600 border-indigo-400 shadow-[0_0_15px_rgba(79,70,229,0.4)]' : 
								  isActive ? 'bg-white border-white shadow-[0_0_20px_rgba(255,255,255,0.3)]' : 
								  'bg-slate-900 border-white/10'}">
								
								${isCompleted ? '<i data-lucide="check" class="w-4 h-4 text-white"></i>' : 
								  `<span class="text-[10px] font-black ${isActive ? 'text-black' : 'text-slate-600'}">${i + 1}</span>`}
							</div>

							<div class="transition-all duration-500 ${isActive ? 'translate-x-2' : ''}">
								<h4 class="text-[11px] font-black uppercase tracking-[0.2em] 
									${isActive ? 'text-white' : isCompleted ? 'text-indigo-300' : 'text-slate-600'}">
									${phase}
								</h4>
								${isActive ? `
									<div class="flex items-center gap-2 mt-1">
										<span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
										<span class="text-[8px] font-black text-emerald-400 uppercase tracking-widest">Active Phase</span>
									</div>
								` : ''}
							</div>
						</div>
					`;
				}).join('');

				lucide.createIcons();
				
				// 2. Fetch Linked Enquiry IDs (for chat)
				const { data: links } = await sb.from('enquiry_details').select('enquiry_id').eq('project_id', projectId);
				activeEnquiryIds = links ? links.map(l => l.enquiry_id) : [];

				// 3. Update Header
				document.getElementById('workspace-title-area').innerHTML = `
					<h1 class="text-4xl font-black text-white tracking-tighter uppercase">${proj.project_name}</h1>
					<p class="text-indigo-400 font-bold text-[10px] uppercase tracking-widest mt-1">${proj.client_email}</p>
				`;

				// 4. Fetch Files directly (No Joins)
				const { data: pFiles, error: fError } = await sb
					.from('project_files')
					.select('*')
					.eq('project_id', projectId)
					.order('created_at', { ascending: false });

				if (fError) console.error("File fetch error:", fError);
				
				// 5. Render
				renderWorkspaceAssets(pFiles); 
				await loadWorkspaceChat(activeProjectId);
				//renderWorkspaceChat();
				lucide.createIcons();

			} catch (err) {
				console.error("Workspace Error:", err);
			}
		}

		function renderWorkspaceAssets(files) {
			const container = document.getElementById('workspace-assets');
			const assetsList = Array.isArray(files) ? files : [];
			
			if (assetsList.length === 0) {
				container.innerHTML = `<div class="col-span-full py-12 text-center text-slate-600 text-[9px] font-black uppercase tracking-[0.3em] border border-dashed border-white/5 rounded-3xl">No documents uploaded</div>`;
				return;
			}

			container.innerHTML = assetsList.map(file => {
				const isImage = /\.(jpg|jpeg|png|webp|avif|gif)$/i.test(file.img_url);
				const date = new Date(file.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
				
				const isYou = file.uploaded_by === (window.userSession?.id); 

				return `
					<div class="bg-slate-900/40 border border-white/5 rounded-3xl overflow-hidden group hover:border-indigo-500/50 transition-all duration-500">
						<div class="aspect-square relative overflow-hidden bg-slate-950">
							${isImage 
								? `<img src="${file.img_url}" class="w-full h-full object-cover opacity-60 group-hover:opacity-100 transition-all duration-700">`
								: `<div class="w-full h-full flex items-center justify-center"><i data-lucide="file-text" class="w-8 h-8 text-slate-700"></i></div>`
							}
							<div class="absolute inset-0 flex items-center justify-center gap-4 opacity-0 group-hover:opacity-100 bg-indigo-600/20 backdrop-blur-sm transition-all">
								<a href="${file.img_url}" target="_blank" class="p-2 bg-white/10 hover:bg-white/20 rounded-full transition-colors">
									<i data-lucide="external-link" class="text-white w-5 h-5"></i>
								</a>
								<button onclick="deleteProjectAsset('${file.id}', '${file.img_url}')" class="p-2 bg-red-500/20 hover:bg-red-500 rounded-full transition-colors text-white">
									<i data-lucide="trash-2" class="w-5 h-5"></i>
								</button>
							</div>
						</div>
						<div class="p-4 border-t border-white/5 bg-white/[0.01]">
							<div class="flex flex-col gap-1">
								<span class="text-[7px] font-black text-slate-500 uppercase tracking-widest">Added By</span>
								<span class="text-[9px] font-bold text-indigo-400 uppercase">${isYou ? 'You' : 'Admin'}</span>
							</div>
							<div class="mt-2 flex flex-col gap-1">
								<span class="text-[7px] font-black text-slate-500 uppercase tracking-widest">Date</span>
								<span class="text-[9px] font-bold text-slate-300 uppercase">${date}</span>
							</div>
						</div>
					</div>
				`;
			}).join('');
			lucide.createIcons();
		}


		async function deleteProjectAsset(recordId, fullImgUrl) {
			if (!confirm("Are you sure you want to permanently delete this file?")) return;

			try {
				// 1. ROBUST PATH EXTRACTION
				// The URL looks like: .../storage/v1/object/public/portal-files/PROJECT_ID/FILENAME.jpg
				// We need: "PROJECT_ID/FILENAME.jpg"
				const bucketName = 'portal-files';
				const urlParts = fullImgUrl.split(`${bucketName}/`);
				
				if (urlParts.length < 2) {
					throw new Error("Could not determine the file path from the URL provided.");
				}

				// Remove any URL parameters (like ?t=...) that Supabase adds for caching
				const storagePath = urlParts[1].split('?')[0];

				console.log("Deleting from Storage:", storagePath);

				// 2. DELETE FROM STORAGE BUCKET
				const { error: storageError } = await sb.storage
					.from(bucketName)
					.remove([storagePath]);

				if (storageError) throw storageError;

				// 3. DELETE FROM DATABASE (project_files table)
				const { error: dbError } = await sb
					.from('project_files')
					.delete()
					.eq('id', recordId);

				if (dbError) {
					console.error("Database Deletion Error:", dbError.message);
					throw new Error("DB Error: " + dbError.message);
				}
				
				showToast("File deleted successfully", "success");	
					
				// 4. REFRESH UI
				// In your script, the ID is stored in currentProjectId globally
				if (activeProjectId) {
					await loadProjectAssets(activeProjectId);
				}

				console.log("Asset successfully removed from storage and database.");

			} catch (err) {
				console.error('Delete error:', err);
				alert('Delete failed: ' + err.message);
			}
		}
		
		// Helper function for the Success Message (if you don't have one)
		function showToast(message, type = "success") {
			const toast = document.createElement('div');
			toast.className = `fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-2xl text-[10px] font-black uppercase tracking-widest z-[100] transition-all duration-500 transform translate-y-20 shadow-2xl border ${
				type === 'success' 
				? 'bg-emerald-500/10 border-emerald-500/50 text-emerald-400' 
				: 'bg-red-500/10 border-red-500/50 text-red-400'
			}`;
			toast.style.backdropFilter = "blur(12px)";
			toast.innerText = message;
			
			document.body.appendChild(toast);
			
			// Animate In
			setTimeout(() => toast.classList.remove('translate-y-20'), 100);
			
			// Animate Out & Remove
			setTimeout(() => {
				toast.classList.add('translate-y-20', 'opacity-0');
				setTimeout(() => toast.remove(), 500);
			}, 3000);
		}
		
		
		async function loadProjectAssets(projectId) {
			try {
				const { data, error } = await sb
					.from('project_files')
					.select('*')
					.eq('project_id', projectId)
					.order('created_at', { ascending: false });

				if (error) throw error;
				renderWorkspaceAssets(data);
			} catch (err) {
				console.error('Error loading assets:', err);
			}
		}
		

		async function refreshAssets(projectId) {
			const { data: newFiles, error } = await sb
				.from('project_files')
				.select('*, profiles(email_id)')
				.eq('project_id', projectId)
				.order('created_at', { ascending: false });

			if (!error) renderWorkspaceAssets(newFiles);
		}

		async function sendWorkspaceMessage() {
			const input = document.getElementById('workspace-msg-input');
			const msg = input.value.trim();
			console.log('Active User: ', window.userSession.id)
			if (!msg || !activeProjectId) return;

			try {
				const { error } = await sb
					.from('project_comments') // Updated table name
					.insert([{
						project_id: activeProjectId,
						author_id: window.userSession.id, // Current logged-in user ID
						description: msg
					}]);

				if (error) throw error;

				input.value = '';
				await loadWorkspaceChat(activeProjectId);
			} catch (err) {
				console.error('Error sending message:', err);
				showToast("Message failed to send", "error");
			}
		}


		async function loadWorkspaceChat(projectId) {
			try {
				console.log('Project ID :', projectId)
				// We fetch from project_comments and JOIN with profiles to get the is_admin flag
				const { data, error } = await sb
					.from('project_comments')
					.select(`
						*,
						profiles:author_id (is_admin)
					`)
					.eq('project_id', projectId)
					.order('created_at', { ascending: true });

				if (error) throw error;
				
				// Always pass an array (data || []) to prevent the .map() error
				renderWorkspaceChat(data || []);
			} catch (err) {
				console.error('Chat Loading Error:', err);
				renderWorkspaceChat([]); 
			}
		}

		function renderWorkspaceChat(comments) {
			const container = document.getElementById('workspace-chat-log');
			if (!container) return;

			// Safety check to ensure comments is an array
			const chatItems = Array.isArray(comments) ? comments : [];

			container.innerHTML = chatItems.map(comment => {
				// The join from Step 1 provides comment.profiles.is_admin
				const isAuthorAdmin = comment.profiles?.is_admin === true;
				
				// ADMIN = LEFT, CLIENT = RIGHT
				const alignmentClass = isAuthorAdmin ? 'justify-start' : 'justify-end';
				const bubbleColor = isAuthorAdmin 
					? 'bg-slate-800/80 border border-white/10 rounded-2xl rounded-tl-none' 
					: 'bg-indigo-600 text-white rounded-2xl rounded-tr-none';

				return `
					<div class="flex ${alignmentClass} mb-4">
						<div class="max-w-[85%] ${bubbleColor} p-4 shadow-xl">
							<div class="flex items-center gap-2 mb-1">
								<span class="text-[7px] font-black uppercase tracking-widest opacity-60">
									${isAuthorAdmin ? 'Architect' : 'Client'}
								</span>
							</div>
							<p class="text-xs leading-relaxed font-medium">${comment.description}</p>
							<div class="mt-2 text-[7px] opacity-40 uppercase font-bold text-right">
								${new Date(comment.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
							</div>
						</div>
					</div>
				`;
			}).join('');

			container.scrollTop = container.scrollHeight;
		}

		function closeWorkspace() {
			document.getElementById('project-workspace').classList.add('hidden');
			document.body.style.overflow = 'auto';
			if (window.currentProjectSub) {
				sb.removeChannel(window.currentProjectSub);
			}
		}
		
		
		async function handleProjectUpload(input) {
			const file = input.files[0];
			if (!file || !activeProjectId) return;

			// 1. Visual feedback: Change button state
			const label = input.parentElement;
			const originalHTML = label.innerHTML;
			label.innerHTML = `<span class="animate-pulse">UPLOADING...</span>`;

			const { data: { user } } = await sb.auth.getUser();
			const fileExt = file.name.split('.').pop();
			const fileName = `${activeProjectId}/${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;

			try {
				// 2. Upload to Storage
				const { error: uploadError } = await sb.storage
					.from('portal-files')
					.upload(fileName, file);

				if (uploadError) throw uploadError;

				const { data: { publicUrl } } = sb.storage.from('portal-files').getPublicUrl(fileName);

				// 3. Insert into DB
				const { error: dbError } = await sb.from('project_files').insert({
					project_id: activeProjectId,
					img_url: publicUrl,
					uploaded_by: user.id,
					created_at: new Date().toISOString()
				});

				if (dbError) throw dbError;
				
				// 4. REFRESH THE ASSETS UI IMMEDIATELY
				const { data: updatedFiles, error: fetchError } = await sb
					.from('project_files')
					.select('*')
					.eq('project_id', activeProjectId)
					.order('created_at', { ascending: false }); // Latest first

				if (!fetchError) {
					renderWorkspaceAssets(updatedFiles);
				}

			} catch (err) {
				console.error(err);
				alert("Upload Error: " + err.message);
			} finally {
				// 5. Reset button and clear input
				label.innerHTML = originalHTML;
				input.value = ''; 
			}
		}
		
        function toggleAllSiblings(btn) {
			const checks = document.querySelectorAll('.sibling-checkbox');
			const newState = !checks[0]?.checked;
			checks.forEach(c => c.checked = newState);
			btn.innerText = newState ? "Deselect All" : "Select All";
		}

        function sendRegistrationInvite(email, name) {
			const regUrl = `${window.location.origin}/index.html`; // Redirect back to index for sign up
			const subject = encodeURIComponent("Nivas Kunj - Dashboard Invitation");
			const body = encodeURIComponent(`Hi ${name},\n\nPlease complete your setup to view your project designs here: ${regUrl}`);
			window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
			alert("Invitation ready for: " + email);
		}

		function closeModal() { document.getElementById('lead-modal').classList.add('hidden'); }
		async function handleLogout() { await sb.auth.signOut(); window.location.href = 'index.html'; }
        lucide.createIcons();
		
		
		async function createActiveProject(leadId, email) {
			const projectName = document.getElementById('project-name').value;
			if (!projectName.trim()) {
				alert("Please enter a Project Name");
				return;
			}

			try {
				const newProjectId = crypto.randomUUID();
				
				// 1. Create the Project record
				const { error: pError } = await sb.from('projects').insert({
					id: newProjectId,
					enquiry_id: leadId,
					project_name: projectName.trim(),
					current_phase: 'Initiation',
					client_email: email
				});

				if (pError) throw pError;

				// 2. Update Enquiry Details to lock the record
				const { error: dError } = await sb.from('enquiry_details').update({ 
					project_id: newProjectId, 
					is_project: true, 
					status_id: 5 // Converted/Active Status
				}).eq('enquiry_id', leadId);

				if (dError) throw dError;

				alert("Project Launched Successfully!");
				manageLead(leadId); // Refresh the modal view immediately
				fetchAdminData();   // Refresh the background pipeline
			} catch (err) {
				console.error(err);
				alert("Launch failed. Please check if a project name already exists or try again.");
			}
		}
		
		async function viewClientComments(enquiryId) {
			const modal = document.getElementById('lead-modal');
			const content = document.getElementById('modal-body-content');
			const title = document.getElementById('modal-title');
			const subtitle = document.getElementById('modal-subtitle');
			
			modal.classList.remove('hidden');
			title.innerText = "Discussion Board";
			subtitle.innerText = "Project Conversation Profile";
			content.innerHTML = `<div class="py-10 text-center animate-pulse text-slate-500 text-[10px] font-bold uppercase tracking-widest">Opening Secure Channel...</div>`;

			try {
				const { data: comments, error } = await sb
					.from('enquiry_comments')
					.select('*')
					.eq('enquiry_id', enquiryId)
					.order('created_at', { ascending: true }); // Changed to Ascending for natural chat flow

				if (error) throw error;

				if (!comments || comments.length === 0) {
					content.innerHTML = `<div class="text-center py-20 text-slate-600 text-[10px] font-black uppercase tracking-widest italic">No messages exchanged yet.</div>`;
					lucide.createIcons();
					return;
				}

				content.innerHTML = `
					<div class="flex flex-col gap-6 max-h-[65vh] overflow-y-auto pr-4 custom-scrollbar p-2">
						${comments.map(c => {
							const isCompany = c.org_comments && c.org_comments.trim() !== "";
							const messageText = isCompany ? c.org_comments : c.comments;
							
							return `
								<div class="flex ${isCompany ? 'justify-start' : 'justify-end'} w-full">
									<div class="max-w-[85%] md:max-w-[70%] flex flex-col ${isCompany ? 'items-start' : 'items-end'}">
										<div class="flex items-center gap-2 mb-1.5 px-1">
											${isCompany ? '<span class="text-[7px] font-black text-indigo-400 uppercase tracking-widest">Nivas Kunj Studio</span>' : ''}
											<span class="text-[7px] text-slate-500 font-bold">${new Date(c.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
											${!isCompany ? '<span class="text-[7px] font-black text-emerald-500 uppercase tracking-widest">You</span>' : ''}
										</div>

										<div class="${isCompany 
											? 'bg-slate-900 border border-white/10 text-slate-200 rounded-2xl rounded-tl-none' 
											: 'bg-indigo-600 text-white rounded-2xl rounded-tr-none shadow-lg shadow-indigo-500/10'} 
											p-4 text-xs font-medium leading-relaxed">
											${messageText}
										</div>
										
										<span class="text-[6px] text-slate-600 mt-1 uppercase font-bold tracking-tighter">
											${new Date(c.created_at).toLocaleDateString()}
										</span>
									</div>
								</div>
							`;
						}).join('')}
					</div>
				`;
				
				// Auto-scroll to bottom of chat
				setTimeout(() => {
					const container = content.querySelector('.custom-scrollbar');
					if (container) container.scrollTop = container.scrollHeight;
				}, 100);

				lucide.createIcons();
			} catch (err) {
				console.error(err);
				content.innerHTML = `<p class="text-red-400 text-center text-[10px] font-black uppercase py-10">Sync Failed</p>`;
			}
		}
		
		async function loadAdminProjects() {
			const grid = document.getElementById('projects-grid');
			const pg = document.getElementById('pagination-controls');
			grid.innerHTML = `<div class="col-span-full p-20 text-center animate-pulse text-slate-400 font-bold text-[10px] uppercase tracking-widest">Filtering Projects...</div>`;

			let query = sb.from('projects').select('*', { count: 'exact' });

			// Use the value from the search bar
			const searchVal = document.getElementById('leadSearch').value.toLowerCase();
			if (searchVal) {
				query = query.or(`project_name.ilike.%${searchVal}%,client_email.ilike.%${searchVal}%`);
			}

			// Use the value from the sort dropdown
			const sortVal = document.getElementById('sortOrder').value;
			if (sortVal === 'newest') query = query.order('created_at', { ascending: false });
			else if (sortVal === 'oldest') query = query.order('created_at', { ascending: true });
			else query = query.order('project_name', { ascending: true });

			// Pagination range
			const start = (currentPage - 1) * itemsPerPage;
			const end = start + itemsPerPage - 1;
			query = query.range(start, end);

			const { data: projects, count, error } = await query;
			if (error) return console.error(error);

			renderPagination(count);

			if (!projects || projects.length === 0) {
				grid.innerHTML = `<div class="col-span-full p-20 text-center text-slate-500 text-[10px] font-bold uppercase tracking-widest border border-dashed border-white/10 rounded-[32px]">No projects found</div>`;
				pg.innerHTML = '';
				return;
			}

			const phases = ['Initiation', 'Design Concept', 'Procurement', 'Installation', 'Handover'];
			grid.innerHTML = projects.map(proj => `
				<div class="glass-panel p-6 rounded-[32px] border border-white/5 hover:border-indigo-500/30 transition-all group">
					<div class="mb-6 flex justify-between items-start">
						<div>
							<h3 class="text-lg font-black text-white uppercase tracking-tighter">${proj.project_name}</h3>
							<p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mt-1">${proj.client_email}</p>
						</div>
					</div>

					<div class="grid grid-cols-2 gap-3 mb-4">
						<div>
							<label class="text-[7px] font-black text-slate-500 uppercase tracking-widest mb-1.5 block">Phase</label>
							<select onchange="updateProjectField('${proj.id}', 'current_phase', this.value)" 
									class="w-full bg-slate-950 border border-white/10 rounded-xl py-2 px-2 text-[9px] font-bold text-white outline-none">
								${phases.map(p => `<option value="${p}" ${proj.current_phase === p ? 'selected' : ''}>${p}</option>`).join('')}
							</select>
						</div>
						<div>
							<label class="text-[7px] font-black text-slate-500 uppercase tracking-widest mb-1.5 block">Completion</label>
							<select onchange="updateProjectField('${proj.id}', 'progress_percent', parseInt(this.value))" 
									class="w-full bg-slate-950 border border-white/10 rounded-xl py-2 px-2 text-[9px] font-bold text-white outline-none">
								${[0, 10, 25, 50, 75, 100].map(v => `<option value="${v}" ${proj.progress_percent === v ? 'selected' : ''}>${v}%</option>`).join('')}
							</select>
						</div>
					</div>

					<div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden mb-6">
						<div class="h-full bg-indigo-500 transition-all duration-700 shadow-[0_0_10px_rgba(79,70,229,0.4)]" style="width: ${proj.progress_percent}%"></div>
					</div>

					<button onclick="openProjectWorkspace('${proj.id}')" 
							class="w-full py-3 bg-white/5 border border-white/10 rounded-2xl text-[9px] font-black text-white uppercase tracking-widest hover:bg-white hover:text-black transition-all">
						Enter Control Room
					</button>
				</div>
			`).join('');
			lucide.createIcons();
		}

		// Single function to update any field in the projects table
		async function updateProjectField(projectId, field, value) {
			const updateData = {};
			updateData[field] = value;

			const { error } = await sb.from('projects').update(updateData).eq('id', projectId);
			
			if (error) {
				console.error("Update failed:", error);
			} else {
				// Refresh grid to reflect the UI changes (like the progress bar width)
				loadAdminProjects();
			}
		}
		
    </script>
	
	<div id="project-workspace" class="fixed inset-0 z-[60] bg-slate-950/95 backdrop-blur-xl hidden overflow-y-auto">
		<div class="max-w-7xl mx-auto min-h-screen p-6 lg:p-12">
			<div class="flex justify-between items-center mb-12">
				<button onclick="closeWorkspace()" class="group flex items-center gap-3 text-slate-500 hover:text-white transition-all">
					<div class="p-3 rounded-full border border-white/10 group-hover:border-indigo-500/50">
						<i data-lucide="arrow-left" class="w-5 h-5"></i>
					</div>
					<span class="text-[10px] font-black uppercase tracking-[0.3em]">Exit Workspace</span>
				</button>
				<div id="workspace-title-area" class="text-right">
					</div>
			</div>

			<div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
				<div class="lg:col-span-4 space-y-6">
					<div class="glass-panel p-8 rounded-[32px] border border-white/10 relative overflow-hidden">
						<div class="absolute top-0 right-0 p-8 opacity-10">
							<i data-lucide="milestone" class="w-20 h-20 text-indigo-500"></i>
						</div>
						<h3 class="text-[10px] font-black text-indigo-400 uppercase tracking-[0.3em] mb-8">Project Roadmap</h3>
						<div id="luxury-timeline" class="space-y-8 relative">
							<div class="absolute left-[15px] top-2 bottom-2 w-[2px] bg-gradient-to-b from-indigo-500 via-slate-800 to-transparent"></div>
							</div>
					</div>

					<div id="workspace-contacts" class="space-y-4"></div>
				</div>

				<div class="lg:col-span-8 space-y-6">
					<div class="glass-panel p-8 rounded-[32px] border border-white/10">
						<div class="flex justify-between items-center mb-8">
							<h3 class="text-[10px] font-black text-white uppercase tracking-[0.3em]">Project Assets</h3>
							<label class="cursor-pointer px-6 py-3 bg-white text-black rounded-full text-[9px] font-black uppercase tracking-widest hover:bg-indigo-400 hover:text-white transition-all">
								Add Files
								<input type="file" class="hidden" onchange="handleProjectUpload(this)">
							</label>
						</div>
						<div id="workspace-assets" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
					</div>

					<div class="glass-panel rounded-[32px] border border-white/10 overflow-hidden flex flex-col h-[500px]">
						<div class="p-6 border-b border-white/5 bg-white/[0.02]">
							<h3 class="text-[10px] font-black text-white uppercase tracking-[0.3em]">Live Discussion & Activity</h3>
						</div>
						<div id="workspace-chat-log" class="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar">
							</div>
						<div class="p-4 bg-slate-900/50 border-t border-white/5">
							<div class="relative">
								<input id="workspace-msg-input" type="text" placeholder="SEND MESSAGE TO ARCHITECT..." 
									   class="w-full bg-white/5 border border-white/10 rounded-2xl py-4 px-6 text-xs text-white placeholder:text-slate-600 focus:border-indigo-500 outline-none transition-all uppercase font-bold tracking-widest">
								<button onclick="sendWorkspaceMessage()" class="absolute right-3 top-2 p-2 text-indigo-400 hover:text-white">
									<i data-lucide="send" class="w-5 h-5"></i>
								</button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
</body>
</html>