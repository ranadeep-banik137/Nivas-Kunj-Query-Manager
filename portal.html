<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nivas Kunj | Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@700;800&family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; background: #fcfcfd; }
        .hidden { display: none !important; }
        .modal-animate { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="loader" class="fixed inset-0 bg-white z-[300] flex flex-col items-center justify-center">
        <div class="w-12 h-12 border-4 border-zinc-200 border-t-indigo-600 rounded-full animate-spin mb-4"></div>
        <p class="text-zinc-500 font-medium text-sm tracking-tight">Verifying Credentials...</p>
    </div>

    <div id="admin-view" class="hidden min-h-screen">
		<nav class="h-20 border-b bg-white px-8 flex items-center justify-between sticky top-0 z-50">
			<h1 class="font-bold text-xl tracking-tight text-indigo-600 uppercase">Nivas Kunj <span class="text-zinc-400 font-medium ml-2">Admin CRM</span></h1>
			<div class="flex items-center gap-6">
				<div class="flex bg-zinc-100 p-1 rounded-xl">
					<button id="tab-enquiries" onclick="switchTab('enquiries')" class="px-4 py-2 text-[10px] font-bold uppercase bg-white shadow-sm rounded-lg transition-all">Enquiries</button>
					<button id="tab-quotes" onclick="switchTab('quotes')" class="px-4 py-2 text-[10px] font-bold uppercase text-zinc-500 hover:text-zinc-800 transition-all">Quotes</button>
				</div>
				<button onclick="handleLogout()" class="px-4 py-2 text-xs font-bold text-zinc-500 hover:text-red-500 transition uppercase tracking-widest">Logout</button>
			</div>
		</nav>
		
		<main class="p-10 max-w-6xl mx-auto">
			<header class="mb-10 flex justify-between items-end">
				<div>
					<h2 class="text-3xl font-extrabold text-zinc-900 tracking-tight">Enquiry Pipeline</h2>
					<p class="text-zinc-500 mt-1">Active enquiries excluding quotes.</p>
				</div>
				<button onclick="fetchAdminData()" class="p-3 bg-zinc-100 rounded-2xl hover:bg-zinc-200 transition">
					<i data-lucide="refresh-cw" class="w-5 h-5 text-zinc-600"></i>
				</button>
			</header>

			<div class="grid grid-cols-12 px-8 mb-4 text-[10px] font-bold uppercase text-zinc-400 tracking-widest">
				<div class="col-span-4">Customer Details</div>
				<div class="col-span-3">Status</div>
				<div class="col-span-2">Tags</div>
				<div class="col-span-3 text-right">Action</div>
			</div>

			<div id="admin-content" class="space-y-3">
				</div>
		</main>
	</div>

    <div id="lead-modal" class="fixed inset-0 bg-zinc-950/60 backdrop-blur-sm z-[400] hidden flex items-center justify-center p-4 sm:p-6">
        <div class="bg-white w-full max-w-4xl max-h-[90vh] rounded-[40px] shadow-2xl flex flex-col overflow-hidden modal-animate">
            <div class="p-8 border-b flex justify-between items-center bg-zinc-50/50">
                <div>
                    <h3 id="modal-title" class="text-2xl font-extrabold text-zinc-900 tracking-tight">Lead Details</h3>
                    <p id="modal-subtitle" class="text-zinc-500 text-sm font-medium"></p>
                </div>
                <button onclick="closeModal()" class="p-3 hover:bg-zinc-200/50 rounded-2xl transition text-zinc-400">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-8 sm:p-12">
                <div id="modal-body-content" class="space-y-10">
                    </div>
            </div>

            <div class="p-8 border-t bg-zinc-50/50 flex justify-end gap-4">
                <button onclick="closeModal()" class="px-8 py-4 text-sm font-bold text-zinc-500 hover:text-zinc-800 transition uppercase">Cancel</button>
                <button id="save-btn" class="px-10 py-4 bg-indigo-600 text-white text-sm font-bold rounded-2xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-100 uppercase">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="client-view" class="hidden min-h-screen bg-slate-50">
        <nav class="h-20 border-b bg-white px-8 flex items-center justify-between">
            <h1 class="font-bold text-xl tracking-tight text-indigo-600 uppercase">Nivas Kunj <span class="text-zinc-400 font-medium ml-2">Client Portal</span></h1>
            <button onclick="handleLogout()" class="px-4 py-2 text-xs font-bold text-zinc-500">Logout</button>
        </nav>
        <main class="p-10 max-w-4xl mx-auto text-center">
            <div class="bg-white p-12 rounded-[48px] shadow-sm border border-zinc-100">
                <h2 class="text-3xl font-extrabold text-zinc-900 mb-4 tracking-tight">Welcome to your Project</h2>
                <p class="text-zinc-500 leading-relaxed">Your design journey is starting. Once the Admin onboards your project, you will see your renders and progress here.</p>
            </div>
        </main>
    </div>

    <script>
		let currentTab = 'enquiries';
        const S_URL = 'https://wbhcvcsdpdandaxidnlg.supabase.co';
        const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndiaGN2Y3NkcGRhbmRheGlkbmxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NjMwMjksImV4cCI6MjA4MTUzOTAyOX0.n8R1OpFxilWbDfteODc-lyVF_qvntyRnJNVM3g9xCWs'; 
        const sb = supabase.createClient(S_URL, S_KEY);

        // --- AUTH CONTROLLER (Same as before) ---
		sb.auth.onAuthStateChange(async (event, session) => {
			const loader = document.getElementById('loader');
			if (session) {
				// 1. Get Profile
				const { data: profile, error } = await sb.from('profiles').select('is_admin, email').eq('id', session.user.id).single();
				
				if (error) { window.location.href = 'index.html'; return; }
				
				loader.classList.add('hidden');
				
				if (profile.is_admin) {
					document.getElementById('admin-view').classList.remove('hidden');
					fetchAdminData();
				} else {
					document.getElementById('client-view').classList.remove('hidden');
					// NEW: Pass the email to the client dashboard loader
					initializeClientDashboard(profile.email);
				}
			} else if (!window.location.hash.includes('access_token')) {
				window.location.href = 'index.html';
			}
		});
		
		async function fetchAdminData() {
			const container = document.getElementById('admin-content');
			container.innerHTML = `<div class="p-20 text-center animate-pulse text-zinc-400 font-bold text-xs">Syncing with Backend...</div>`;
			
			const isQuoteFilter = currentTab === 'quotes';
			const [rawRes, custRes, detRes, statRes] = await Promise.all([
				sb.from('raw_enquiries').select('*').eq('is_quote', isQuoteFilter).order('created_at', { ascending: false }),
				sb.from('customer_details').select('*'),
				sb.from('enquiry_details').select('*'),
				sb.from('enquiry_status').select('*')
			]);

			if (rawRes.error) { container.innerHTML = "Error loading data"; return; }

			const enquiries = rawRes.data;

			if (enquiries.length === 0) {
				container.innerHTML = `<div class="p-20 text-center text-zinc-400">No active enquiries found.</div>`;
				return;
			}

			container.innerHTML = enquiries.map(lead => {
				// Mapping the data carefully based on IDs
				const customer = custRes.data?.find(c => c.enquiry_id === lead.id) || {};
				const detail = detRes.data?.find(d => d.enquiry_id === lead.id) || {};
				const statusLabel = statRes.data?.find(s => s.status_id === detail.status_id)?.status_details || 'New';

				return `
					<div class="grid grid-cols-12 items-center bg-white p-6 rounded-[24px] border border-zinc-100 shadow-sm hover:border-indigo-300 transition-all group">
						<div class="col-span-4">
							<div class="flex items-center gap-4">
								<div class="w-10 h-10 rounded-full bg-zinc-100 flex items-center justify-center text-zinc-400 font-bold text-xs uppercase">
									${customer.customer_name ? customer.customer_name.charAt(0) : '?'}
								</div>
								<div>
									<h3 class="font-bold text-zinc-900 text-sm">${customer.customer_name || 'Anonymous'}</h3>
									<p class="text-[10px] text-zinc-400 font-medium">${customer.email_id || lead.email_id}</p>
								</div>
							</div>
						</div>

						<div class="col-span-3">
							<span class="px-3 py-1 bg-zinc-50 border border-zinc-100 text-zinc-600 text-[10px] font-bold rounded-lg uppercase tracking-wider">
								${statusLabel}
							</span>
						</div>

						<div class="col-span-2 flex gap-2">
							${customer.is_member ? '<span title="Registered Member" class="w-5 h-5 bg-indigo-100 text-indigo-600 rounded-md flex items-center justify-center"><i data-lucide="shield-check" class="w-3 h-3"></i></span>' : ''}
							${customer.whatsapp_updates ? '<span title="WhatsApp Active" class="w-5 h-5 bg-emerald-100 text-emerald-600 rounded-md flex items-center justify-center"><i data-lucide="message-circle" class="w-3 h-3"></i></span>' : ''}
						</div>

						<div class="col-span-3 text-right">
							<button onclick="manageLead('${lead.id}')" class="bg-zinc-900 text-white px-5 py-2.5 rounded-xl text-[10px] font-bold uppercase tracking-widest hover:bg-indigo-600 transition shadow-lg shadow-zinc-100">
								Manage
							</button>
						</div>
					</div>
				`;
			}).join('');
			
			lucide.createIcons();
		}

		// --- MANAGE LEAD MODAL (Step 2 Implementation) ---

		async function manageLead(leadId) {
			currentEditingId = leadId;
			const modal = document.getElementById('lead-modal');
			const content = document.getElementById('modal-body-content');
			modal.classList.remove('hidden');
			content.innerHTML = `<div class="py-20 text-center animate-pulse text-zinc-400 text-xs font-bold uppercase tracking-widest">Loading Enquiry Workspace...</div>`;

			// 1. Fetch primary data for this specific enquiry
			const [leadRes, custRes, detRes, commRes, statRes, quoteRes, imagesRes] = await Promise.all([
				sb.from('raw_enquiries').select('*').eq('id', leadId).single(),
				sb.from('customer_details').select('*').eq('enquiry_id', leadId).single(),
				sb.from('enquiry_details').select('*').eq('enquiry_id', leadId).single(),
				sb.from('enquiry_comments').select('*').eq('enquiry_id', leadId).order('created_at', { ascending: false }),
				sb.from('enquiry_status').select('*'),
				sb.from('quote_details').select('*').eq('enquiry_id', leadId).maybeSingle(),
				sb.from('quote_images').select('image_url').eq('enquiry_id', leadId)
			]);
			
			const lead = leadRes.data;
			const customer = custRes.data;
			const details = detRes.data;
			const email = customer?.email_id || lead?.email_id;
			const quote = quoteRes.data;
			const images = imagesRes.data || [];
			const { data: profile } = await sb
				.from('profiles')
				.select('*')
				.eq('client_email', email)
				.single();

			const isRegistered = !!profile;
			
			// 2. Build the Header and Contact Section
			document.getElementById('modal-title').innerText = `${customer?.customer_name || 'New Lead'} - Query`;
			document.getElementById('modal-subtitle').innerText = lead.query_data;

			content.innerHTML = `
				<div class="p-6 bg-white rounded-[32px] border border-zinc-100 shadow-sm">
					<h4 class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-4">Client Access</h4>
					
					<div class="flex items-center justify-between p-4 ${isRegistered ? 'bg-emerald-50' : 'bg-amber-50'} rounded-2xl">
						<div>
							<p class="text-[11px] font-bold ${isRegistered ? 'text-emerald-700' : 'text-amber-700'}">
								${isRegistered ? 'REGISTERED USER' : 'PENDING REGISTRATION'}
							</p>
							<p class="text-[10px] text-zinc-500">${email}</p>
						</div>
						${isRegistered ? 
							`<i data-lucide="shield-check" class="text-emerald-500 w-5 h-5"></i>` : 
							`<button onclick="sendRegistrationInvite('${email}', '${customer.customer_name}')" 
								class="p-2 bg-white border border-amber-200 rounded-xl hover:bg-amber-100 transition">
								<i data-lucide="send" class="w-4 h-4 text-amber-600"></i>
							</button>`
						}
					</div>
					
					${!isRegistered ? `<p class="mt-3 text-[9px] text-zinc-400 italic text-center">Click the icon to send registration link</p>` : ''}
				</div>
				<div class="space-y-8">
					<div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-6 bg-zinc-50 rounded-[32px] border border-zinc-100">
						<div class="space-y-1">
							<label class="text-[10px] font-bold text-zinc-400 uppercase ml-2">Customer Name</label>
							<input id="edit-name" type="text" value="${customer?.customer_name || ''}" class="w-full px-5 py-3 bg-white border border-zinc-200 rounded-2xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500 transition">
						</div>
						<div class="space-y-1">
							<label class="text-[10px] font-bold text-zinc-400 uppercase ml-2">Contact Number</label>
							<input id="edit-phone" type="text" value="${customer?.phone_number || ''}" class="w-full px-5 py-3 bg-white border border-zinc-200 rounded-2xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500 transition">
						</div>
						<div class="space-y-1">
							<label class="text-[10px] font-bold text-zinc-400 uppercase ml-2">Email Address</label>
							<input id="edit-email" type="text" value="${email || ''}" class="w-full px-5 py-3 bg-white border border-zinc-200 rounded-2xl text-sm font-semibold outline-none focus:ring-2 focus:ring-indigo-500 transition">
						</div>
					</div>
					
					${getQuoteHTML(quote, images)}

					<div id="onboarding-zone" class="p-8 border-2 border-dashed border-zinc-200 rounded-[40px] text-center">
						${details?.is_project ? `
							<div class="flex flex-col items-center gap-2">
								<div class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center mb-2">
									<i data-lucide="check-circle" class="w-6 h-6"></i>
								</div>
								<h4 class="text-sm font-bold text-zinc-900 uppercase">Project Already Onboarded</h4>
								<p class="text-xs text-zinc-400 font-mono">Project ID: ${details.project_id}</p>
							</div>
						` : `
							<button onclick="searchSiblingsForOnboarding('${leadId}', '${email}')" class="px-10 py-4 bg-zinc-900 text-white rounded-2xl text-xs font-bold uppercase tracking-widest hover:bg-indigo-600 transition shadow-xl">
								Onboard this enquiry to a project
							</button>
						`}
					</div>

					<div class="space-y-4">
						<h4 class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest ml-2">History & Comments</h4>
						<div class="flex gap-2">
							<input id="new-comment" placeholder="Add a comment..." class="flex-1 px-6 py-4 bg-zinc-100 border-none rounded-2xl text-sm outline-none focus:ring-2 focus:ring-indigo-500 transition">
							<button onclick="addComment('${leadId}')" class="px-8 py-4 bg-zinc-200 text-zinc-600 rounded-2xl text-[10px] font-bold uppercase hover:bg-zinc-800 hover:text-white transition">Post</button>
						</div>
						<div class="space-y-3 max-h-60 overflow-y-auto pr-2">
							${commRes.data?.length > 0 ? commRes.data.map(c => `
								<div class="p-5 bg-white border border-zinc-100 rounded-[24px]">
									<div class="flex justify-between items-center mb-1">
										<span class="text-[9px] font-bold text-indigo-500 uppercase">${c.org_comments || 'Note'}</span>
										<span class="text-[9px] text-zinc-400 font-bold">${new Date(c.created_at).toLocaleString()}</span>
									</div>
									<p class="text-xs text-zinc-600 leading-relaxed">${c.comments}</p>
								</div>
							`).join('') : '<p class="text-xs text-zinc-400 italic text-center py-6">No comments recorded yet.</p>'}
						</div>
					</div>
				</div>
			`;
			lucide.createIcons();
			document.getElementById('save-btn').onclick = () => saveLeadChanges(leadId);
		}
		
		async function searchSiblingsForOnboarding(primaryId, email) {
			console.log("Searching siblings for email:", email);
			const zone = document.getElementById('onboarding-zone');
			zone.innerHTML = `<div class="py-10 animate-pulse text-zinc-400 text-xs font-bold uppercase">Searching Cluster...</div>`;

			try {
				// STEP A: Find all enquiry_ids linked to this email in customer_details
				const { data: customerEntries, error: custError } = await sb
					.from('customer_details')
					.select('enquiry_id')
					.eq('email_id', email);

				if (custError) throw custError;

				// Extract the IDs into an array
				const allEnquiryIds = customerEntries.map(ce => ce.enquiry_id);

				// STEP B: Fetch the actual enquiry details for these IDs
				const { data: siblings, error: sibError } = await sb
					.from('raw_enquiries')
					.select(`
						id, created_at, query_data, 
						customer_details(customer_name, phone_number, email_id)
					`)
					.in('id', allEnquiryIds); // Use .in() to match all related IDs

				if (sibError) throw sibError;

				const otherLeads = siblings.filter(s => s.id !== primaryId);

				// RENDER THE BOX (UI remains as you requested)
				zone.innerHTML = `
					<div class="text-left bg-zinc-50 p-6 rounded-[32px] border border-zinc-200">
						<div class="flex justify-between items-center mb-6">
							<div>
								<h4 class="text-sm font-bold text-zinc-900">Step 2: Sync Related Enquiries</h4>
								<p class="text-[10px] text-zinc-500">Found ${otherLeads.length} other entries for ${email}.</p>
							</div>
							<button onclick="toggleAllSiblings(this)" class="px-4 py-2 bg-white border border-zinc-200 rounded-xl text-[10px] font-bold text-indigo-600 uppercase">Select All</button>
						</div>

						<div class="space-y-3 max-h-80 overflow-y-auto mb-6 pr-2">
							<div class="p-4 bg-white border-2 border-indigo-100 rounded-2xl flex items-center gap-4 opacity-60">
								<input type="checkbox" checked disabled class="w-5 h-5 accent-indigo-600">
								<div class="flex-1 grid grid-cols-4 gap-4 text-[10px] font-medium text-zinc-500 items-center">
									<span class="font-bold text-zinc-900 uppercase">Current Lead</span>
									<span class="truncate">${email}</span>
									<span class="truncate italic">Primary Source</span>
									<span class="text-right text-[8px] font-mono">ID: ${primaryId.slice(0,8)}</span>
								</div>
							</div>

							${otherLeads.map(s => `
								<div class="p-4 bg-white border border-zinc-100 rounded-2xl flex items-center gap-4 hover:border-indigo-300 transition">
									<input type="checkbox" class="sibling-checkbox w-5 h-5 accent-indigo-600" value="${s.id}" checked>
									<div class="flex-1 grid grid-cols-4 gap-4 text-[10px] font-medium text-zinc-600 items-center">
										<span class="font-bold text-zinc-900 truncate">${s.customer_details?.[0]?.customer_name || 'Anonymous'}</span>
										<span class="truncate">${s.customer_details?.[0]?.email_id || 'N/A'}</span>
										<span class="truncate italic">"${s.query_data || 'No Message'}"</span>
										<span class="text-right text-zinc-400 font-mono">${s.customer_details?.[0]?.phone_number || 'N/A'}</span>
									</div>
								</div>
							`).join('')}
						</div>

						<div class="flex justify-center">
							<button onclick="executeBulkOnboarding('${primaryId}', '${email}')" class="px-12 py-4 bg-emerald-600 text-white rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-emerald-700 transition shadow-lg shadow-emerald-100">
								Confirm & Start Project
							</button>
						</div>
					</div>
				`;
			} catch (err) {
				console.error("Search Logic Failed:", err);
				zone.innerHTML = `<p class="text-red-500 text-xs text-center">Search error: ${err.message}</p>`;
			}
		}
		
		async function executeBulkOnboarding(primaryId, email) {
			const zone = document.getElementById('onboarding-zone');
			const customerName = document.getElementById('edit-name').value || "New Client";
			const newProjectId = crypto.randomUUID();

			const checkboxes = document.querySelectorAll('.sibling-checkbox:checked');
			const idsToLink = [primaryId, ...Array.from(checkboxes).map(cb => cb.value)];

			zone.innerHTML = `<div class="py-10 text-zinc-400 text-xs font-bold animate-pulse uppercase">Generating Project ID: ${newProjectId.slice(0,8)}...</div>`;

			try {
				// 1. Entry into projects table
				const { error: projectErr } = await sb.from('projects').insert({
					id: newProjectId,
					enquiry_id: primaryId,
					project_name: customerName.trim() + "'s Project",
					current_phase: 'Onboarding',
					client_email: email
				});
				if (projectErr) {
					console.error("Project Insert Error:", projectErr);
					throw projectErr;
				}

				// 2. Update enquiry_details for EACH chosen enquiry
				const { error: detailsErr } = await sb.from('enquiry_details')
					.update({
						project_id: newProjectId,
						is_project: true,
						status_id: 5 
					})
					.in('enquiry_id', idsToLink);
				
				if (detailsErr) {
					console.error("Details Update Error:", detailsErr);
					throw detailsErr;
				}

				alert(`SUCCESS:\n- 1 Project Created (${newProjectId.slice(0,8)})\n- ${idsToLink.length} Enquiries Linked`);
				closeModal();
				if (typeof fetchAdminData === "function") fetchAdminData();
				//fetchAdminData();
			} catch (err) {
				console.error("Critical Onboarding Failure:", err);
				alert("Execution failed. Check console for details.");
				// Reset the UI so the admin can try again
				searchSiblingsForOnboarding(primaryId, email); 
			}
		}
		
		function toggleAllSiblings(btn) {
			const checks = document.querySelectorAll('.sibling-checkbox');
			const newState = !checks[0]?.checked;
			checks.forEach(c => c.checked = newState);
			btn.innerText = newState ? "Deselect All" : "Select All";
		}

		function closeModal() { document.getElementById('lead-modal').classList.add('hidden'); }
		async function handleLogout() { await sb.auth.signOut(); window.location.href = 'index.html'; }
        lucide.createIcons();
		async function saveLeadChanges(leadId) {
			const saveBtn = document.getElementById('save-btn');
			const name = document.getElementById('edit-name').value;
			const phone = document.getElementById('edit-phone').value;
			const statusId = document.getElementById('edit-status').value;

			saveBtn.disabled = true;
			saveBtn.innerText = "Syncing...";

			// Perform updates
			const updates = [
				sb.from('customer_details').update({ customer_name: name, phone_number: phone }).eq('enquiry_id', leadId),
				sb.from('enquiry_details').update({ status_id: statusId }).eq('enquiry_id', leadId)
			];

			await Promise.all(updates);
			
			saveBtn.innerText = "Saved!";
			setTimeout(() => {
				closeModal();
				fetchAdminData();
				saveBtn.innerText = "Save Changes";
				saveBtn.disabled = false;
			}, 1000);
		}

		async function addComment(leadId) {
			const commentText = document.getElementById('new-comment').value;
			if (!commentText.trim()) return;

			await sb.from('enquiry_comments').insert({
				enquiry_id: leadId,
				comments: commentText,
				org_comments: "Admin Note"
			});

			// Refresh the modal content to show the new comment
			manageLead(leadId);
		}
		
		async function showClientView(userId) {
			const container = document.getElementById('client-content');
			const userEmail = (await sb.auth.getUser()).data.user.email;

			// 1. Find all enquiries for this email
			const { data: userLeads } = await sb
				.from('raw_enquiries')
				.select(`
					id, 
					created_at,
					enquiry_details ( is_project, project_id )
				`)
				.eq('email_id', userEmail);

			// 2. Find the active project linked to these enquiries
			const activeProjectId = userLeads?.find(l => l.enquiry_details?.project_id)?.enquiry_details.project_id;

			if (!activeProjectId) {
				container.innerHTML = `
					<div class="py-20 text-center">
						<i data-lucide="clock" class="w-12 h-12 text-zinc-300 mx-auto mb-4"></i>
						<h3 class="text-xl font-bold text-zinc-900">Enquiry Received</h3>
						<p class="text-zinc-500 max-w-xs mx-auto mt-2">We have received your ${userLeads.length} enquiries. An admin will onboard your project shortly.</p>
					</div>
				`;
				lucide.createIcons();
				return;
			}

			// 3. Fetch the Project Details
			const { data: project } = await sb
				.from('projects')
				.select('*')
				.eq('id', activeProjectId)
				.single();

			container.innerHTML = `
				<div class="space-y-8">
					<div class="bg-indigo-600 p-8 rounded-[32px] text-white">
						<p class="text-[10px] font-bold uppercase tracking-widest opacity-60">Active Project</p>
						<h2 class="text-3xl font-black mt-2">${project.project_name}</h2>
						<div class="mt-6 flex items-center gap-2">
							<span class="px-3 py-1 bg-white/20 rounded-full text-[10px] font-bold uppercase">${project.current_phase}</span>
						</div>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="p-6 bg-white border rounded-[24px]">
							<h4 class="text-xs font-bold text-zinc-400 uppercase mb-4 tracking-wider">Linked Enquiries</h4>
							<div class="space-y-3">
								${userLeads.map(l => `
									<div class="p-3 bg-zinc-50 rounded-xl text-xs font-medium text-zinc-600 flex justify-between">
										<span>Enquiry #${l.id.slice(0,5)}</span>
										<span class="text-[9px] text-zinc-400">${new Date(l.created_at).toLocaleDateString()}</span>
									</div>
								`).join('')}
							</div>
						</div>
					</div>
				</div>
			`;
			lucide.createIcons();
		}
		
		function sendRegistrationInvite(email, name) {
			// In a real app, you'd call a Supabase Edge Function or an API here.
			// For now, let's generate the link and simulate the process.
			const regUrl = `${window.location.origin}/register?email=${encodeURIComponent(email)}`;
			
			// Copy to clipboard or open mailto
			const subject = encodeURIComponent("Complete your Registration - Nivas Kunj");
			const body = encodeURIComponent(`Hi ${name},\n\nPlease complete your registration to access your project portal here: ${regUrl}`);
			
			window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
			
			alert("Email client opened. Link generated:\n" + regUrl);
		}
		
		async function loadClientPortal(userEmail) {
			// 1. Fetch the project linked to this email
			const { data: project } = await sb
				.from('projects')
				.select('*')
				.eq('client_email', userEmail)
				.single();

			if (project) {
				// 2. Fetch all enquiries linked to this project
				const { data: enquiries } = await sb
					.from('enquiry_details')
					.select('*, raw_enquiries(*)')
					.eq('project_id', project.id);

				renderClientProjectView(project, enquiries);
			} else {
				renderNoProjectState();
			}
		}
		
		// Client view
		async function initializeClientDashboard(email) {
			const main = document.querySelector('#client-view main');
			main.innerHTML = `<div class="py-20 text-center animate-pulse text-zinc-400 font-bold text-xs uppercase">Loading Your Project...</div>`;
			console.log("Initiatlizing client dashboard with email:", email)
			// 1. Fetch project mapped to this email
			const { data: project, error: pError } = await sb
				.from('projects')
				.select('*')
				.eq('client_email', email)
				.single();

			if (pError || !project) {
				main.innerHTML = `
					<div class="bg-white p-12 rounded-[48px] shadow-sm border border-zinc-100">
						<h2 class="text-3xl font-extrabold text-zinc-900 mb-4 tracking-tight">Project Pending</h2>
						<p class="text-zinc-500 leading-relaxed">We found your account, but your project is still being prepared by our team. Check back soon!</p>
					</div>`;
				return;
			}

			// 2. Fetch all enquiries linked to this project
			const { data: enquiries } = await sb
				.from('enquiry_details')
				.select('*, raw_enquiries(query_data, created_at)')
				.eq('project_id', project.id);

			// 3. Render the Project Dashboard
			main.innerHTML = `
				<div class="max-w-4xl mx-auto space-y-8 text-left">
					<div class="bg-indigo-600 p-10 rounded-[48px] text-white shadow-2xl shadow-indigo-100">
						<div class="flex justify-between items-start">
							<div>
								<p class="text-[10px] font-bold uppercase tracking-[0.2em] opacity-70 mb-2">Active Project</p>
								<h2 class="text-4xl font-black tracking-tighter">${project.project_name}</h2>
							</div>
							<span class="px-4 py-2 bg-white/20 backdrop-blur-md rounded-xl text-[10px] font-bold uppercase tracking-widest border border-white/20">
								${project.current_phase}
							</div>
						</div>
					</div>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
						<div class="bg-white p-8 rounded-[40px] border border-zinc-100 shadow-sm">
							<h4 class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-6">Linked History</h4>
							<div class="space-y-4">
								${enquiries.map(e => `
									<div class="p-4 bg-zinc-50 rounded-2xl">
										<p class="text-[10px] font-bold text-indigo-600 mb-1">${new Date(e.raw_enquiries.created_at).toLocaleDateString()}</p>
										<p class="text-xs text-zinc-600 italic">"${e.raw_enquiries.query_data}"</p>
									</div>
								`).join('')}
							</div>
						</div>

						<div class="bg-white p-8 rounded-[40px] border border-zinc-100 shadow-sm flex flex-col justify-center items-center text-center">
							<div class="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mb-4">
								<i data-lucide="sparkles" class="w-8 h-8"></i>
							</div>
							<h4 class="text-sm font-bold text-zinc-900">Designs Incoming</h4>
							<p class="text-xs text-zinc-400 mt-2 px-4">Your personalized renders and layout plans will appear here once finalized.</p>
						</div>
					</div>
				</div>
			`;
			lucide.createIcons();
		}
		
		function switchTab(tab) {
			currentTab = tab;
			const enqBtn = document.getElementById('tab-enquiries');
			const quoBtn = document.getElementById('tab-quotes');
			
			if (tab === 'quotes') {
				quoBtn.className = "px-4 py-2 text-[10px] font-bold uppercase bg-white shadow-sm rounded-lg";
				enqBtn.className = "px-4 py-2 text-[10px] font-bold uppercase text-zinc-500 hover:text-zinc-800";
			} else {
				enqBtn.className = "px-4 py-2 text-[10px] font-bold uppercase bg-white shadow-sm rounded-lg";
				quoBtn.className = "px-4 py-2 text-[10px] font-bold uppercase text-zinc-500 hover:text-zinc-800";
			}
			fetchAdminData();
		}
		
		function getQuoteHTML(q, images) {
			if (!q) return '';
			return `
				<div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-6">
					<div class="p-3 bg-white border border-zinc-100 rounded-2xl">
						<p class="text-[8px] font-bold text-zinc-400 uppercase">Flat Type</p>
						<p class="text-xs font-bold">${q.flat_type}</p>
					</div>
					<div class="p-3 bg-white border border-zinc-100 rounded-2xl">
						<p class="text-[8px] font-bold text-zinc-400 uppercase">Bedrooms</p>
						<p class="text-xs font-bold">${q.bedrooms}</p>
					</div>
					<div class="p-3 bg-white border border-zinc-100 rounded-2xl">
						<p class="text-[8px] font-bold text-zinc-400 uppercase">Area</p>
						<p class="text-xs font-bold">${q.area_sqft} sqft</p>
					</div>
					<div class="p-3 bg-white border border-zinc-100 rounded-2xl">
						<p class="text-[8px] font-bold text-zinc-400 uppercase">Package</p>
						<p class="text-xs font-bold text-indigo-600">${q.package}</p>
					</div>
				</div>
				${images.length > 0 ? `
					<div class="mb-6">
						<p class="text-[10px] font-bold text-zinc-400 uppercase tracking-widest mb-3">Property Photos</p>
						<div class="flex gap-2 overflow-x-auto pb-2">
							${images.map(img => `
								<a href="${img.image_url}" target="_blank">
									<img src="${img.image_url}" class="h-24 w-24 object-cover rounded-xl border border-zinc-200 hover:opacity-80 transition">
								</a>
							`).join('')}
						</div>
					</div>
				` : ''}
			`;
		}
		
    </script>
</body>
</html>